CORE_SRC = compiler.cs class.cs feature.cs compiler_proxy.cs core_assembly_info.cs custom_attribute_factory.cs compiler_proxy_i.cs feature_info.cs

RUNTIME_SRC = run-time/*.cs run-time/types/*.cs

CSFLAGS = -nologo -w:4 -optimize+
#CSFLAGS = -nologo -w:4 -optimize+ -debug

GACFLAGS=-nologo
NMAKEFLAGS=-nologo
COM_WIZARD_FLAGS = -output_none
#COM_WIZARD_FLAGS = -output_all
MKDIR = -mkdir
RMDIR = -rd /q /s
CP = -copy
MAKE = nmake
NGEN = -ngen

COMPILER = EiffelCompiler
RUNTIME = ise_runtime


all: $(COMPILER).dll run-time\$(RUNTIME).dll

run-time\$(RUNTIME).dll: $(RUNTIME_SRC) run-time\makefile
	cd run-time
	$(MAKE) $(NMAKEFLAGS)
	cd ..

$(COMPILER).dll: $(CORE_SRC) makefile run-time\$(RUNTIME).dll
	csc $(CSFLAGS) -target:library -reference:System.Web.Services.dll \
		-reference:run-time\$(RUNTIME).dll -out:$@ $(CORE_SRC)
	gacutil $(GACFLAGS) -if $@
	tlbexp -nologo $@
	regasm -nologo $@

generate_eiffel: compiler.idl
	$(RMDIR) junk
	$(MKDIR) junk
	$(CP) compiler.idl junk
	$(ISE_EIFFEL)\wizards\com\com_wizard_cmd.exe -new_com_project -com_file compiler.idl -in_process -destination $(EIFFEL_SRC)\Eiffel\eiffel\com_il_generation\Core\junk $(COM_WIZARD_FLAGS)
	$(CP) junk\Client\Clib\*.cpp clib
	$(CP) junk\Client\Include\*.h clib
	$(CP) junk\Client\Component\*.e ..
	$(CP) junk\Common\Include\ecom_eiffelcompiler_compiler_proxy_i.h clib
	$(CP) junk\Common\Interfaces\*.e ..
	cd clib
	call make_msc.bat

optimize: $(COMPILER).dll run-time\$(RUNTIME).dll
	$(NGEN) -delete $(COMPILER)
	$(NGEN) -delete $(RUNTIME)
	$(NGEN) $(COMPILER).dll
	$(NGEN) run-time\$(RUNTIME).dll
