<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML EXPERIMENTAL 970324//EN">
<HTML>
<HEAD>
<META NAME="GENERATOR" CONTENT="Microsoft FrontPage 4.0">
<LINK REL="STYLESHEET" HREF="../../styles/tech.css">
<TITLE>EiffelCOM</TITLE><meta name="Microsoft Border" content="t, default">
</HEAD>
<BODY BGCOLOR="#ffffff"><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td><table border="0" cellspacing="0" cellpadding="0" width="100%">
  <tr>
    <td valign="top" bgcolor="#000063" width="291"><b><font face="Arial" size="4" color="#FFFFFF">Interactive<br>
      Software Engineering</font></b></td>
    <td valign="top" bgcolor="#000063" width="720"><b><font face="Arial" size="6" color="#FFFFCC">EiffelCOM</font></b></td>
  </tr>
  <tr>
    <td colspan="2" valign="top" width="100%">
<p align="center"><nobr>[&nbsp;<a href="../../index.html">Home</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../../release_notes.html">Release&nbsp;Notes</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../index.html">Technology&nbsp;Papers</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../../install.html">Installation&nbsp;Notes</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../../Eiffel/index.html">About&nbsp;Eiffel</a>&nbsp;]</nobr>
<hr>

    </td>
  </tr>
</table></td></tr><!--msnavigation--></table><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><!--msnavigation--><td valign="top">
<h1>
<A NAME="pgfId=1004393">
 </A>
<A NAME="85207">
 </A>
The EiffelCOM Library</h1>
<p><A NAME="pgfId=1004397">
 </A>
The EiffelCOM library adds compound files support to your Eiffel applications. Compound files are structured files that can embed different types of data in a single file. It is the ideal format to store documents including different types of information. It is the format used by Microsoft&#174; Office applications. This chapter will not cover the compound files architecture itself but will focus on its support in EiffelCOM. It requires that the user be familiar with compound files and the compound files API.
<p><A NAME="pgfId=1004403">
 </A>
The EiffelCOM library enables the creation and use of the IRootStorage, IStorage and IStream interfaces and includes a wrapping of all necessary structures for handling compound files. It also includes classes that encapsulates all necessary flags and constants.
<DIV>
<H2 CLASS="dd-sec2">
<A NAME="pgfId=998071">
 </A>
Compound Files</H2>
<OL>
<LI CLASS="nn-first">
<A NAME="pgfId=999169">
 </A>
The cluster ecom_storage includes the files ecom_root_storage.e, ecom_storage.e and ecom_stream.e. These files correspond to the IRootStorage, IStorage and IStream interfaces, respectively.</LI>
</OL>
<DIV>
<H3 CLASS="dd-sec3">
<A NAME="pgfId=999170">
 </A>
<A NAME="19134">
 </A>
Storages</H3>
<OL>
<LI CLASS="nn-first">
<A NAME="pgfId=1004438">
 </A>
Storages are to compound files what directories are to a standard file system. They can include nested storages and/or streams. Streams are the equivalent of files in a standard file system. They include the data itself. The following features are available on ECOM_STORAGE objects:</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998109">
 </A>
destroy_element (element_name: STRING) -- removes the stream or the substorage element_name of Current. You can cancel this action using a call to revert (described later). Thus, commit (described later) will be called to confirm the deletion. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998113">
 </A>
copy_to (stg_dest: ECOM_STORAGE) -- copies Current into stg_dest.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998117">
 </A>
move_element_to (element_name: STRING; stg_dest: ECOM_STORAGE; new_element_name: STRING; movmode: INTEGER) -- moves the stream or substorage element_name to stg_dest and renames element_name as new_element_name. movmode can take one of the values described in ECOM_STGMOVE.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998121">
 </A>
rename_element (old_element_name, new_element_name: STRING) -- renames the stream or substorage old_elment_name as new_element_name. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998125">
 </A>
set_class (clsid: STRING) -- set the class identifier of Current using the clsid value.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998129">
 </A>
commit (mode: INTEGER) -- commits all changes made in Current. The commits all streams and substorages included in Current. mode can take one of the values described in ECOM_STGC. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998133">
 </A>
revert -- discards all changes made to Current. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998137">
 </A>
is_compound_file (filename: STRING): BOOLEAN -- checks if the system file filename is a compound file (Result = True) or not (Result = False). </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998141">
 </A>
enum_elements: ARRAY [ECOM_STATSTG] -- enumerates the ECOM_STATSTG structures associated with the streams and substorages included in Current.</LI>
</OL>
</DIV>
<DIV>
<H3 CLASS="dd-sec3">
<A NAME="pgfId=998142">
 </A>
Streams</H3>
<OL>
<LI CLASS="nn-first">
<A NAME="pgfId=1004444">
 </A>
Streams are where the data is actually stored. Different streams can store different types of data. The following features are available on ECOM_STREAM objects:</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998146">
 </A>
seek (offset, origin: INTEGER) -- sets the position of the seek pointer by adding offset to origin. origin can contain one of the values described in ECOM_STREAM_SEEK. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998150">
 </A>
set_size (new_size: INTEGER) -- sets the size of the stream to new_size. If the new_size value is larger than the current size of the stream, then the new bytes fill with undefined values. If the new_size value is smaller than the current size, the stream truncates.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=1003778">
 </A>
copy_to (stream_dest: ECOM_STREAM; num_bytes_to_copy: INTEGER) -- copies num_bytes_to_copy to stream_dest.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=1003779">
 </A>
commit (mode: INTEGER) -- commits all changes made to the stream. mode can take one of the values described in ECOM_STGC. Compound file implementation does not support opening streams in transacted mode, so this method primarily flushes memory buffers. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998162">
 </A>
revert -- discards all changes made to the stream. Compound file implementation does not support opening streams in transacted mode, so this method has no effect.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998166">
 </A>
stat (stat_flag: INTEGER) -- fills an ECOM_STATSTG structure that corresponds to current stream.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998170">
 </A>
read (buff: POINTER; num_bytes_to_read: INTEGER): INTEGER -- reads num_bytes_to_read bytes from the stream into buff. Returns the actual number of bytes read.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998174">
 </A>
write (buff: POINTER; num_bytes_to_write: INTEGER): INTEGER -- writes the num_bytes_to_write bytes of buffer pointed by buff to stream, and the returns the number of bytes actually written. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998178">
 </A>
lock_region (offset, count: ECOM_LARGE_INTEGER; lock: INTEGER) -- restricts access to the range of bytes defined by offset and count. lock can take one of the values described in ECOM_LOCKTYPES. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998182">
 </A>
unlock_region (offset, count: ECOM_LARGE_INTEGER; lock: INTEGER) -- removes the access restriction previously set using lock_region. The arguments are the same as for lock_region.</LI>
<LI CLASS="nn-normal">
<A NAME="pgfId=998183">
 </A>
The last two features may of may not be available, depending on the COM interface that the Eiffel class wraps. If the interface does not support region locking, then the status code is set to Stg_e_invalidfunction. The standard Windows implementation of compound file does not support region locking. </LI>
<LI CLASS="nn-normal">
<A NAME="pgfId=998184">
 </A>
All of the previous features directly encapsulate the COM IStream interface. Thus, read/write is not very effective, since it requires a pointer on a buffer, which is not directly available in Eiffel. As a result, the ECOM_STREAM class offers the following read/write features: </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998188">
 </A>
read_string -- reads a string at the current seek position in the stream and sets last_string accordingly. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998192">
 </A>
read_character-- reads a character at the current seek position in the stream and sets last_character accordingly. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=1003817">
 </A>
read_integer-- reads an integer at the current seek position in the stream and sets last_integer accordingly. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=1003818">
 </A>
read_real-- reads a real at the current seek position in the stream and sets last_real accordingly. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=1003819">
 </A>
read_boolean-- reads a Boolean at the current seek position in the stream and sets last_boolean accordingly. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998208">
 </A>
write_string (s: STRING) -- writes s at the current seek position in the stream. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998212">
 </A>
write_character (c: CHARACTER) -- writes c at the current seek position in the stream. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998216">
 </A>
write_integer (i: INTEGER) -- writes i an integer at the current seek position in the stream. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998220">
 </A>
write_real (r: REAL) -- writes r at the current seek position in the stream. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998224">
 </A>
write_boolean (b: BOOLEAN) -- writes b at the current seek position in the stream. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998228">
 </A>
end_of_stream: BOOLEAN -- True when the end of the stream is reached.</LI>
<LI CLASS="nn-normal">
<A NAME="pgfId=998229">
 </A>
The attribute end_of_stream automatically updates when there is a call to any of the read/write features. </LI>
</OL>
</DIV>
<DIV>
<H3 CLASS="dd-sec3">
<A NAME="pgfId=998230">
 </A>
Other classes</H3>
<OL>
<LI CLASS="nn-first">
<A NAME="pgfId=998231">
 </A>
The EiffelCOM compound file interfaces also need several other classes. These classes handle the ECOM_STATSTG structure included in the ecom_structure cluster and require some of the constants defined in the ecom_flags cluster. </LI>
<LI CLASS="nn-normal">
<A NAME="pgfId=998232">
 </A>
The ECOM_STATSTG class is a direct encapsulation of the STATSTG structure. The following attributes can be set/accessed </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998236">
 </A>
element_name: STRING -- name of element (storage or stream). </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998240">
 </A>
element_type: INTEGER -- type of element (storage, stream). Result can take one of the values described in ECOM_STGTY. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998244">
 </A>
element_size: INTEGER -- size of element in bytes (stream). </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998248">
 </A>
modification_time: WEL_FILE_TIME -- last modification time. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998252">
 </A>
creation_time: WEL_FILE_TIME -- creation time. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998256">
 </A>
access_time: WEL_FILE_TIME -- last access time. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998260">
 </A>
open_mode: INTEGER -- mode in which element was opened. Result can take one of the values described in ECOM_STGM. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998264">
 </A>
locks_supported: INTEGER -- A group of flags relevant only for stream. For each lock item, indicates whether or not a call to lock_region is worthwhile. Result can take one of the values described in ECOM_LOCK_TYPE. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998268">
 </A>
clsid: STRING -- class identifier associated with the storage. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998272">
 </A>
state_bits: INTEGER -- last state bits set on element (storage).</LI>
<LI CLASS="nn-normal">
<A NAME="pgfId=998273">
 </A>
The following are the classes that encapsulate the COM constants: </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998277">
 </A>
ECOM_LOCK_TYPES -- defines the different lock types available for a storage element. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998281">
 </A>
ECOM_STAT_FLAGS -- specifies which field of the ECOM_STATSTG structure associated with the element to fill. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998285">
 </A>
ECOM_STGC -- SToraGe Commit mode; defines the various available commit modes.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=1003843">
 </A>
ECOM_STGM -- SToraGe Mode; defines the opening mode for an element (storage or stream).</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=1003844">
 </A>
ECOM_STGMOVE -- SToraGe MOVE; defines how to move a storage.</LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=1003845">
 </A>
ECOM_STGTY -- SToraGe TYpe; defines the element type: storage, stream or lockbyte. </LI>
<LI CLASS="ll-bull">
<A NAME="pgfId=998301">
 </A>
ECOM_STREAM_SEEK -- defines the current position of the seek pointer in a stream.</LI>
</OL>
</DIV>
<DIV>
<H3 CLASS="dd-sec3">
<A NAME="pgfId=1004480">
 </A>
Summary</H3>
<OL>
<LI CLASS="nn-first">
<A NAME="pgfId=1004484">
 </A>
The EiffelCOM library gives access to the main compound files functionality. It allows to create, edit and delete compound files. If your application needs to save different types of data in one single file then compound files provide an easy and straightforward support.</LI>
</OL>
</DIV>
</DIV>
  &nbsp;
<!--msnavigation--></td></tr><!--msnavigation--></table></BODY>
</HTML>
