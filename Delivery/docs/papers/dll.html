<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>Shared library generation</title>
<link rev="made" href="mailto:webmaster@eiffel.com">
<link rel="stylesheet" href="../styles/tech.css" type="text/css">
<meta name="Microsoft Border" content="t, default">
</head>

<body><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td><table border="0" cellspacing="0" cellpadding="0" width="100%">
  <tr>
    <td valign="top" bgcolor="#000063" width="291"><b><font face="Arial" size="4" color="#FFFFFF">Interactive<br>
      Software Engineering</font></b></td>
    <td valign="top" bgcolor="#000063" width="720"><b><font face="Arial" size="6" color="#FFFFCC">Shared library generation</font></b></td>
  </tr>
  <tr>
    <td colspan="2" valign="top" width="100%">
<p align="center">[<a href="http://eiffel.com">ISE Home</a>] <nobr>[&nbsp;<a href="../index.html">Home</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../release_notes.html">Release&nbsp;Notes</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="index.html">Technology&nbsp;Papers</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../install.html">Installation&nbsp;Notes</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../Eiffel/index.html">About&nbsp;Eiffel</a>&nbsp;]</nobr>
<hr>

    </td>
  </tr>
</table></td></tr><!--msnavigation--></table><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><!--msnavigation--><td valign="top"><table cols="1" cellpadding="5" cellspacing="0" border="0">
<tr><td>

    <ul>
      <li><A 
  href="#Overview">Overview</A> 

      <li><A 
  href="#def">The 
  definition file</A> 
      <li><A 
  href="#Why">Why this 
  tool ?</A> 
      <li><A 
  href="#Selecting">Selecting 
  and creating a definition file - Lace option</A> 
      <li><A 
  href="#Dynamic">Dynamic 
  Library tool bar</A> 
      <li><A 
  href="#How">How to 
  use it ?</A> 
      <li><A 
  href="#c_level">At 
  the C level</A> </li>
    </ul>
<H2><a name=Overview>Overview</a></H2><A href="#TOP"><IMG 
align=right alt=TOP border=1 src="../images/top.gif" width="27" height="27"></A> 
<P>The ISE Eiffel compiler offers now the possibility to generate a <B>dynamic 
shared library</B> of the system. </P>
<P>Thanks to this dynamic library, the user will be able to call an Eiffel feature from a C program, by using the real name of the feature.</P>
<P>The user can generate a DLL <I>(*.dll)</I> of the system on windows, and a 
shared library <I>(*.so)</I> on Unix.</P>
<P>For that, the user has to <I>describe</I> what he want to <I>export</I> in 
its dynamic library. This is done via the definition file <I>(*.def)</I> in 
which the user will specify the feature he wants to export.</P>
<!-- ------------------------------------------------------------ -->
<A name=def></A>
<H2>The Definition File</H2><A 
href="#TOP"><IMG 
align=right alt=TOP border=1 src="../images/top.gif" width="27" height="27"></A> 
<P>The syntax is pretty simple when you understand what you need to export a 
feature: you need the name of the <B>feature</B>, the name of the concerned 
<B>class</B>, and the name of a <B>creation procedure</B>, what is optional is 
to specify an <B>index</B>, and an <B>alias</B>. The index is mainly to create a 
DLL for windows, and the alias to export the feature under a different name.</P>
<H3>Syntax</H3>
    <ul>
      <TABLE bgColor=#ffffff border=3 cellPadding=5 cellSpacing=0>
    <TBODY>
    <TR>
      <TD><B>Export_feature</B></TD>
      <TD bgColor=#ffffe8>Class_name [Creation_part] "<B>:</B>" Feature 
        [Optional_part]</TD></TR>
    <TR>
      <TD><B>Creation_part</B></TD>
      <TD bgColor=#ffffe8>"<B>(</B>" feature_name "<B>)</B>"</TD></TR>
    <TR>
      <TD><B>Optional_part</B></TD>
      <TD bgColor=#ffffe8>[Index_part] [Alias_part]</TD></TR>
    <TR>
      <TD><B>Index_part</B></TD>
      <TD bgColor=#ffffe8>"<B>@</B>" <I>integer</I></TD></TR>
    <TR>
      <TD><B>Alias_part</B></TD>
      <TD bgColor=#ffffe8>"<B>Alias</B>" 
<I>alias_name</I></TD></TR>
    <TR>
      <TD><b>Call_type_part</b></TD>
      <TD bgColor=#ffffe8>"<b>call_type</b>" <i>call_type_name</i></TD></TR></TBODY></TABLE>
    </ul>
<H3>Example</H3>
    <ul>
      <TABLE bgColor=#ffffff border=3 cellPadding=5 cellSpacing=0>
    <TBODY>
    <TR>
      <TD><FONT size=+1><FONT color=purple>ROOT_CLASS <FONT 
        color=green>(make): foo <FONT color=black><B>@</B><FONT color=blue> 4 
        <FONT color=black>Alias <FONT color=blue>my_foo 
        </FONT></FONT></FONT></FONT></FONT></FONT><font color="blue"> </font>call_type<font color="blue">
        __stdcall</font></FONT></TD></TR></TBODY></TABLE>
    </ul>
<H3>Constraint</H3>
    <ul>
      <ul>
        <li><U>on the feature:</U> 
          <ul>
            it could be any feature except : an attribute, and a deferred feature
          </ul>
        <li><U>on the creation procedure:</U> 
          <ul>
            It must have zero argument, and no return type.
          </ul>
        <li><U>on the alias name:</U> 
          <ul>
            It must be a valid name for a C function.
          </ul>
        <li><U>on the index:</U> 
          <ul>
            It must be strictly positive.
          </ul>
        <li><U>on the call type:</U> 
          <ul>
            It must be a valid call type for the targeted platform (useful for
      Windows only).
          </ul>
        </li>
      </ul>
  <P>
  &nbsp;
      <li>For each feature you will need to specify a <B>class</B>, a <B>creation 
  procedure</B>,and a <B>feature</B>.
        <ul>
          <li>If the feature is a creation procedure then do not specify any creation, 
    it will use the feature as creation. For example <B>ROOT_CLASS: make</B>.
          <li>If the class has no creation procedure, do not specify any creation.</li>
        </ul>
<H3>The definition file</H3>
        <ul>
          <TABLE bgColor=#ffffff border=3 cellPadding=5 cellSpacing=0 width=500>
    <TBODY>
    <TR>
      <TD width=300><PRE>-- EXPORTED FEATURE(s) OF THE SHARED LIBRARY
-- SYSTEM : demo

-- CLASS [BAR]
BAR (make_b) : get_string
BAR (make_a) : print_bar

-- CLASS [ROOT_CLASS]
ROOT_CLASS : make
ROOT_CLASS (make) : foo
ROOT_CLASS (make) : test_bar </PRE></TD>
      <TD bgColor=#ffffe8><PRE>-
-Name of the Eiffel system
-
-Class BAR
-here get_string uses make_b as creation
-here print_bar uses make_a as creation
-
-
-here the feature is also a creation
-
- </PRE></TD></TR></TBODY></TABLE>
        </ul>
        <!-- ------------------------------------------------------------ --><A 
href="#Why" 
name=Why></A>
<H2>Why this tool ?</H2><A 
href="#TOP"><IMG 
align=right alt=TOP border=1 src="../images/top.gif" width="27" height="27"></A> 
<P>This tool is a wizard to help the user to build its definition file. It will 
use a simple drag and drop mechanism, and has the possibility to store different 
definition files.</P>
<P>The tool will check the validity of the creation procedure, of the feature, 
and basically will say when it is not possible. </P><!-- ------------------------------------------------------------ --><A 
href="#Selecting" 
name=Selecting></A>
<H2>Selecting and creating a definition file - Lace option</H2><A 
href="#TOP"><IMG 
align=right alt=TOP border=1 src="../images/top.gif" width="27" height="27"></A> 
<P>When you first open your dynamic library tool, the user will have to choose 
or create an Eiffel definition file :</P>
<P>At this point, 2 choices: Browse to open an existing definition file, or 
create the default file. A dialog box will appear :</P><IMG align=bottom 
alt=IMAGE border=1 src="../images/opendyn.gif" width="343" height="121"> 
<P>If you open the default file, Ebench will create the file and open the 
dynamic library tool.</P><IMG align=bottom alt=IMAGE border=1 
src="../images/defdyn.gif" width="450" height="203"> 
<P>Now, the user can use this tool to build its definition file with a simple 
drag and drop mechanism.</P> 
<P>&nbsp;</P><P>Starting with ISE EiffelBench 4.5 there are two ways to select
    an existing definition file. The first method is described above, but it has
    the limitation that each time you recompile your project from scratch, you
    will need to redo the previous steps. The second method is to use the new
    lace definition (see <a href="lace.html">Lace</a>) `<b>shared_library_definition</b>'
    in your Ace file. By specifying a definition file in your ace file, the
    Eiffel compiler will look at it to generate the DLL.</P> 
<P>&nbsp;</P><!-- ------------------------------------------------------------ --><A 
href="#Dynamic" 
name=Dynamic></A>
<H2>Dynamic Library tool bar</H2><A 
href="#TOP"><IMG 
align=right alt=TOP border=1 src="../images/top.gif" width="27" height="27"></A> <IMG align=bottom 
alt=IMAGE border=1 src="../images/dyntool.gif" width="454" height="362"> 
<P>The Dynamic Library toolbar is composed of <BR><BR>
        <ul>
          <ul>
            <li><IMG align=bottom alt=OPEN/SAVE border=1 src="../images/opensave.gif" width="48" height="28"> 
    open/save part<BR>- to save or open a new eiffel definition file 
    (*.def).<BR><BR>
            <li><IMG align=bottom alt=FORMAT border=1 src="../images/format.gif" width="52" height="28"> format 
    part:<BR>- to select clickable format, or text format.<BR><BR>
            <li><IMG align=bottom alt=ICON border=1 src="../images/dynicon.gif" width="27" height="27"> the 
    dynamic lib icon:<BR>- to reload the definition file<BR><font color="red">Warning!!
              : this will cancel your changes, and reload the 
    file</font><BR><BR></li>
          </ul>
        </ul>
        <!-- ------------------------------------------------------------ --><A 
href="#How" 
name=How></A>
<H2>How to use it ?</H2><A 
href="#TOP"><IMG 
align=right alt=TOP border=1 src="../images/top.gif" width="27" height="27"></A> 
<P>The way to use the Dynamic Library Tool is simple, you first open your tool, 
as describe before, then you just <B>drag and drop</B> the feature you want to 
export into the Dynamic Library Tool or the corresponding button, if you do not 
follow the constraints, a warning dialog will pop up.</P>
<P>In case of a class with severals valid creation procedures, a dialog will pop 
up, with a list of <B>valid creation procedure</B> (ie: no argument).</P><IMG 
align=bottom alt=ICON border=1 src="../images/creation.gif" width="158" height="127"> <!-- ------------------------------------------------------------ --><A 
name=c_level></A>
<H2>At the C level</H2><A 
href="#TOP"><IMG 
align=right alt=TOP border=1 src="../images/top.gif" width="27" height="27"></A> 
    <P>Basically, once the Eiffel definition file is created, the compiler will 
generate a set of files and will compile them to generate the Dynamic
    library into the <I>EIFGEN/W_code</I> or <I>EIFGEN/F_code</I>  directory.</P>
    <P><FONT color=#888888 
size=-1><U>Note:</U> to generate and compile these files, you have to open at least once 
your definition file, during your current session, this way EiffelBench will 
know which one to use, if you do not specify any definition file, nothing will 
be generated. </FONT></P>
<P>The set of files is composed of: </P>
        <ul>
          <ul>
            <li><B>EIFGEN/W_code/<FONT color=blue><I>system</I>.def</FONT></B> (or 
    F_code)
            <li><B>EIFGEN/W_code/<FONT color=blue>edynlib.c</FONT></B> (or F_code)
            <li><B>$(EIFFEL5)/bench/spec/$(PLATFORM)/templates/<FONT 
    color=blue>egc_dynlib.template</FONT></B><BR>this file will be copied during 
    the compilation into the EIFGEN/W_code/E1 directory as <B><FONT 
    color=blue>egc_dynlib.c</font></B>
            <li><B>$(EIFFEL5)/bench/spec/$(PLATFORM)/include/<FONT 
    color=blue>egc_dynlib.h</FONT></B> 
            <li>and the Makefile</li>
            </ul>
          </ul>
<P>The <I><FONT color=blue>system.def</FONT></I> is use only on windows, this 
files is the definition file used to generate a DLL at the linking.</P>
          <ul>
            <TABLE bgColor=#ffffff border=3 cellPadding=5 cellSpacing=0>
    <TBODY>
    <TR>
      <TD><PRE>LIBRARY demo.dll
DESCRIPTION DEMO.DLL

EXPORTS

;System
	init_rt
	reclaim_rt

; CLASS [BAR]
	get_string
	print_bar

; CLASS [ROOT_CLASS]
	make
	foo
	test_bar
</PRE></TD>
      <TD bgColor=#ffffe8><PRE>- Information about the DLL
- ...
-
- The following are EXPORTed functions.
-
- This part concerns the RunTime.
-	initialize the RT.
-	reclaim the Eiffel object.
-
- The exported for the CLASS BAR
-	get_string
-	print_bar
-
- The exported for the CLASS BAR
-	make
-	foo
-	test_bar
</PRE></TD></TR></TBODY></TABLE>
          </ul>
<P>The <I><FONT color=blue>edynlib.c</FONT></I> file is the "interface" between 
the Eiffel system, and the C code, basically it contains the declaration, and 
implementation of the function used to call directly the eiffel feature with its 
real name.</P>
<P>The <I><FONT color=blue>egc_dynlib.c and egc_dynlib.h</FONT></I> files are 
used for the operation by the RunTime. </P>
      </ul>
    </font></td></tr></table>&nbsp;<!--msnavigation--></td></tr><!--msnavigation--></table></BODY>
