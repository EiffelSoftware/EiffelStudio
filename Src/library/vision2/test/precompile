#!/bin/bash
#===============================================================================
# Precompilation test for Eiffel Vision
# Tries to precompile the latest Eiffel Vision from CVS,
# exit 0 on success, 1 on failure.
#-------------------------------------------------------------------------------
#$Id$
#===============================================================================


# Make a temporary directory.
cd /tmp
tmpdir=v2_precompile_$$
mkdir $tmpdir
cd $tmpdir

# By default set up for GEL.
platform_lib=gel
platform_sep='/'
if [ uname | grep CYGWIN > /dev/null 2>&1 ]
then
	platform_lib=wel
	platform_sep='\\'
fi

# Check out base, event, the platform library and vision2.
#cvs -d :pserver:$USER@cvs:/home/cvs co -r dev46_manu_new_base base > /dev/null 2>&1
cvs -d :pserver:$USER@cvs:/home/cvs co base > /dev/null 2>&1
cvs -d :pserver:$USER@cvs:/home/cvs co event > /dev/null 2>&1
cvs -d :pserver:$USER@cvs:/home/cvs co $platform_lib > /dev/null 2>&1
cvs -d :pserver:$USER@cvs:/home/cvs co vision2 > /dev/null 2>&1

# Delete files that are marked "Not for release".
cd vision2
make > /dev/null 2>&1
for file in `find . -name '*.e'`
do
	if grep "^--| FIXME Not for release" $file > /dev/null 2>&1
	then
		rm -f $file
	fi
done
cd ..

# Create an Ace file for precompilation.
echo "system test" > Ace.ace
echo "root ANY" >> Ace.ace
echo "cluster" >> Ace.ace
echo "dev: \"${platform_sep}tmp$platform_sep$tmpdir\"" >> Ace.ace
echo "event(dev): \"\$${platform_sep}event\"" >> Ace.ace
echo "$platform_lib(dev): \"\$${platform_sep}$platform_lib\"" >> Ace.ace
echo "all vision2(dev): \"\$${platform_sep}vision2\"" >> Ace.ace
echo "  exclude" >> Ace.ace
echo "    \"mswin\";" >> Ace.ace
echo "    \"new_figures\";" >> Ace.ace
echo "    \"obsolete\";" >> Ace.ace
echo "    \"components\";" >> Ace.ace
echo "    \"test\";" >> Ace.ace
echo "    \"release\";" >> Ace.ace
echo "  end" >> Ace.ace
echo "all base(dev): \"\$${platform_sep}base\"" >> Ace.ace
echo "  exclude" >> Ace.ace
echo "    \"table_eiffel3\";" >> Ace.ace
echo "  end" >> Ace.ace
echo "end" >> Ace.ace

# Run the compiler.
if es4 -precompile -stop > out 2>&1
then
	tail -4 out
	cd /tmp
	rm -rf $tmpdir
	exit 0
else
	cat out
	cd /tmp
	rm -rf $tmpdir
	exit 1
fi

#===============================================================================
# CVS Log
#===============================================================================
#
# $Log$
# Revision 1.5  2001/06/07 23:08:57  rogers
# Merged DEVEL branch into Main trunc.
#
# Revision 1.4.4.1  2000/05/03 19:10:21  oconnor
# mergred from HEAD
#
# Revision 1.4  2000/03/17 17:13:24  oconnor
# change to trunk of Eiffel Base
#
# Revision 1.2  2000/03/09 17:05:10  oconnor
# added comments
#
#===============================================================================
