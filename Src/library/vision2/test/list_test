#!/bin/bash
#===============================================================================
# Dynamic list test for Eiffel Vision
# Runs lists tests on latest Vision from CVS,
# exit 0 on success, 1 on failure.
#-------------------------------------------------------------------------------
#$Id$
#===============================================================================


# Make a temporary directory.
cd /tmp
tmpdir=v2_list_test_$$
mkdir $tmpdir
cd $tmpdir

# By default set up for GEL.
platform_lib=gel
platform_sep='/'
if  uname | grep CYGWIN > /dev/null 2>&1
then
	platform_lib=wel
	platform_sep='\\'
fi

# Check out base, event, the platform library and vision2.
#cvs -d :pserver:$USER@cvs:/home/cvs co -r dev46_manu_new_base base > /dev/null 2>&1
cvs -d :pserver:$USER@cvs:/home/cvs co base > /dev/null 2>&1
cvs -d :pserver:$USER@cvs:/home/cvs co event > /dev/null 2>&1
cvs -d :pserver:$USER@cvs:/home/cvs co $platform_lib > /dev/null 2>&1
cvs -d :pserver:$USER@cvs:/home/cvs co vision2 > /dev/null 2>&1

# Delete files that are marked "Not for release".
cd vision2
make > /dev/null 2>&1
for file in `find . -name '*.e'`
do
	if grep "^--| FIXME Not for release" $file > /dev/null 2>&1
	then
		rm -f $file
	fi
done
cd ..

# Create an Ace file for list_test.
echo "system dynamic_list_test" > Ace.ace
echo "root EV_DYNAMIC_LIST_TEST: make_and_launch" >> Ace.ace
echo "default" >> Ace.ace
echo "  assertion (all)" >> Ace.ace
echo "cluster" >> Ace.ace
echo "dev: \"${platform_sep}tmp$platform_sep$tmpdir\"" >> Ace.ace
echo "event(dev): \"\$${platform_sep}event\"" >> Ace.ace
echo "$platform_lib(dev): \"\$${platform_sep}$platform_lib\"" >> Ace.ace
echo "all vision2(dev): \"\$${platform_sep}vision2\"" >> Ace.ace
echo "  exclude" >> Ace.ace
echo "    \"mswin\";" >> Ace.ace
echo "    \"new_figures\";" >> Ace.ace
echo "    \"obsolete\";" >> Ace.ace
echo "    \"release\";" >> Ace.ace
echo "  end" >> Ace.ace
echo "all base(dev): \"\$${platform_sep}base\"" >> Ace.ace
echo "  exclude" >> Ace.ace
echo "    \"table_eiffel3\";" >> Ace.ace
echo "  end" >> Ace.ace
if [ "$platform_lib" == "gel" ]
then
	echo "external" >> Ace.ace
	echo "  include_path: \"/tmp/$tmpdir/vision2/implementation/gtk/Clib \`gtk-config --cflags\`\";" >> Ace.ace
	echo "  object: \"/tmp/$tmpdir/vision2/implementation/gtk/Clib/gtk_eiffel.o\"," >> Ace.ace
	echo "\"\`gtk-config --libs\`\";" >> Ace.ace
fi
echo "end" >> Ace.ace

exit_status=1
# Run the compiler.
if es4 -stop > out 2>&1
then
	cd EIFGEN/W_code
	if finish_freezing >> ../../out 2>&1
	then
		echo "Test report format:" > ../../out 2>&1
		echo "feature_tested result" >> ../../out 2>&1
		echo "For a passed test result is :)" >> ../../out 2>&1
		echo "On failure failed_in_state(errror_detected) is displayed" >> ../../out 2>&1
		echo >> ../../out 2>&1
		if ./dynamic_list_test >> ../../out 2>&1
		then
			exit_status=0
		fi
	fi
	cd ../..
fi

cat out
#cp out /tmp/out$$
cd /tmp
rm -rf $tmpdir
exit $exit_status

#===============================================================================
# CVS Log
#===============================================================================
#
# $Log$
# Revision 1.3  2001/06/07 23:08:57  rogers
# Merged DEVEL branch into Main trunc.
#
# Revision 1.2.4.1  2000/05/03 19:10:21  oconnor
# mergred from HEAD
#
# Revision 1.2  2000/03/17 17:12:17  oconnor
# added explanation of output
#
# Revision 1.1  2000/03/10 19:12:13  oconnor
# list test script
#
# Revision 1.3  2000/03/09 22:28:57  oconnor
# added tail of successful output
#
# Revision 1.2  2000/03/09 17:05:10  oconnor
# added comments
#
#===============================================================================
