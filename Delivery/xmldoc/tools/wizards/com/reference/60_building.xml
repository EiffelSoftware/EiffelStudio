<document title="Building a COM Component" output="studio">
	<meta_data/>
	<paragraph>
		<paragraph>
			The EiffelCOM wizard allows for  the development of both in-process (DLLs) and out-of-process (EXEs) COM components in Eiffel. 
		</paragraph>
		<heading>
			<size>2</size> Using the Generated Code
		</heading>
		<paragraph>
			If the project consits of adding a COM interface to an existing Eiffel project then the wizard will generate (and optionally compile) everything required to 
			implement the COM component. No extra work is required.
		</paragraph>
		<paragraph>
			If the project uses a COM definition file (either an IDL file or a type library), the EiffelCOM Wizard generates empty features in the classes corresponding 
			to the component's coclasses. The implementation can then be added into these empty features.
		</paragraph>
		<warning>
			<bold>Warning</bold>: Depending on the project settings, the EiffelCOM Wizard may overwrite the files containing the classes corresponding to the component's 
			colasses if the project is re-generated thereby replacing the implemented features with empty ones. Make sure the destination folder is different from the 
			folder where the classes have been implemented prior to re-generating the project.
		</warning>
		<paragraph>
			Unlike the code generated to access an existing component, the code generated to implement a new COM component will differ for an in-process or an 
			out-of-process component. The difference lies in the component activation code in the class 
			<class_name>ECOM_&lt;Name_of_system&gt;_REGISTRATION</class_name>. If the component is in-process then this class includes the four functions 
			that need to be exported from an in-process COM component ( 
			<feature_name>DllRegisterServer</feature_name>, 
			<feature_name>DllUnregisterServer</feature_name>, 
			<feature_name>DllGetClassObject</feature_name>, and 
			<feature_name>DllCanUnloadNow</feature_name>). If the component is out-of-process then the registration class includes a feature initializing the component 
			and its graphical user interface.
		</paragraph>
		<paragraph>
			The architecture of the generated code is similar to the one used by the code generated to access an existing component: classes corresponding to the component's 
			coclasses inherit from classes corresponding to the component's interfaces and implement all the deferred features. There is however a major difference: the 
			classes corresponding to the component's coclasses should <bold>not</bold> be inherited from. Instead their implementation should be completed. Putting the 
			implementation in a heir class would cause a runtime failure since the EiffelCOM generated code will instantiate the class corresponding to the component's 
			coclass when being called rather than any descendant that would actually contain the implementation. The classes corresponding to the component's coclasses are 
			all suffixed with <class_name>_COCLASS_IMP</class_name>.
		</paragraph>
		<heading>
			<size>2</size>  Component's GUI
		</heading>
		<paragraph>
			In the case of an out-of-process server, the component might need a Graphical User Interface. There are two different scenarios in which the 
			component can be activated: either its user launched it explicitly (e.g. by double clicking the executable icon) or it was launched by the COM runtime to satisfy a client 
			request. In some cases it might be required for the component to have a different behavior in these two cases (for example the GUI could only be necessary when 
			the component was launched explicitely by the user but should be hidden when launched by the COM runtime). The generated registration class for an out-of-process 
			server includes the feature:
		</paragraph>
		<code_block>
<feature_name>main_window</feature_name><symbol>:</symbol> <class_name>WEL_FRAME_WINDOW</class_name></code_block>
		<paragraph>
			This feature is a <keyword>once</keyword> function that can return the class corresponding to the component window. By default, This window is displayed only if 
			COM does not start the component. When COM loads an out-of-process component, it appends the command line parameter "-embedding" to the executable. The 
			generated registration class looks for this option and if it is part of the process argument list then it sets the default window appearance to hidden. Of course this 
			default implementation may be modified if needed.
		</paragraph>
		<heading>
			<size>2</size>
			<content>Exceptions</content>
		</heading>
		<paragraph>
			The COM standard specifies that each COM routine should return a status code to the client. The status code is encoded in a <class_name>HRESULT</class_name> 
			value. Such behavior goes against the Command Query Separation Principle in Eiffel. The EiffelCOM generated system should use exceptions instead of returning 
			<class_name>HRESULT</class_name> values to the client. By default the EiffelCOM runtime will always return <feature_name>S_OK</feature_name> meaning that the 
			routine succeeded. To notify the client of a problem (e.g. invalid argument value), the EiffelCOM component should raise the corresponding exception from class 
			<class_name>ECOM_EXCEPTION</class_name> using the feature <feature_name>trigget</feature_name> from the same class. The EiffelCOM runtime will catch the 
			exception and send the corresponding <class_name>HRESULT</class_name> back to the client. Here is what the Eiffel code for a COM component should look like:
		</paragraph>
		<code_block>
<keyword>indexing</keyword>
	description<symbol>:</symbol> <string>"Eiffel coclass server example"</string>
<keyword>class</keyword>
	<class_name> ECOM_SERVER_COCLASS_IMP</class_name>

<keyword>inherit</keyword>
	<class_name>ECOM_SERVER_COCLASS</class_name> <comment>-- Generated by the wizard</comment>

	<class_name>ECOM_EXCEPTION</class_name>
		<keyword>export</keyword>
			<symbol>{</symbol>NONE<symbol>}</symbol> <keyword>all</keyword>
		<keyword>end</keyword>

<keyword>feature</keyword> <comment>-- Basic Operations</comment>

	<feature_name>coclass_feature</feature_name> <symbol>(</symbol><local_variable>an_argument</local_variable><symbol>:</symbol> <class_name>ARGUMENT_TYPE</class_name><symbol>)</symbol> <keyword>is</keyword>
			<comment> -- Example of a coclass feature</comment>
		<keyword>do</keyword>
			<keyword>if</keyword> <keyword>not</keyword> <feature_name>is_valid</feature_name> <symbol>(</symbol><local_variable>an_argument</local_variable><symbol>)</symbol> <keyword>then</keyword>
				<feature_name>trigger</feature_name> <symbol>(</symbol><feature_name>E_invalidargument</feature_name><symbol>)</symbol>
			<keyword>else</keyword>
				<comment>-- Normal processing</comment>
			<keyword>end</keyword>
		<keyword>end</keyword>

<keyword>feature</keyword> <symbol>{</symbol><class_name>NONE</class_name><symbol>}</symbol> <comment>-- Implementation</comment>

	<feature_name>is_valid</feature_name> <symbol>(</symbol><local_variable>an_argument</local_variable><symbol>:</symbol> <class_name>ARGUMENT_TYPE</class_name><symbol>)</symbol><symbol>:</symbol> <class_name>BOOLEAN</class_name> <keyword>is</keyword>
			<comment>-- Is an_argument a valid argument?</comment>
		<keyword>do</keyword>
			<comment>-- Test of validity of an_argument</comment>
		<keyword>end</keyword>
		
<keyword>end</keyword> <comment>-- class ECOM_SERVER_COCLASS_IMP</comment></code_block>
		<paragraph>
			 This class inherits from the generated Eiffel coclass and from <class_name>ECOM_EXCEPTION</class_name>. It redefines the feature 
			 <feature_name>coclass_feature</feature_name> from the generated coclass. This feature is part of the interface functions that can be 
			 called by clients of the component. Its implementation uses the feature<feature_name>trigger</feature_name> from 
			 <class_name>ECOM_EXCEPTION</class_name> to raise exceptions in case the feature cannot be executed normally (invalid argument). 
			 The EiffelCOM runtime catches the exception and maps it into an <class_name>HRESULT</class_name> that is sent back to the client.
		</paragraph>
		<seealso>
			<bold>See Also</bold>: <link><url>10_how_wizard_works.xml</url><label>How the EiffelCOM Wizard Works</label></link>, 
			<link><url>20_generated_files.xml</url><label>Generated Files</label></link>, 
			<link><url>30_class_hierarchy.xml</url><label>Class Hierarchy</label></link>, 
			<link><url>40_eiffel_project.xml</url><label>Adding a COM Interface to an Eiffel Project</label></link>,
			<link><url>50_accessing.xml</url><label>Accessing a COM Component</label></link>,
			<link><url>60_reusing.xml</url><label>Reusing a COM Component</label></link>,
			<link><url>70_options.xml</url><label>Command Line Options</label></link>
		</seealso>
		</paragraph>
</document>
