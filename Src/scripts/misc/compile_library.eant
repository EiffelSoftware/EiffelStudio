<?xml version="1.0"?>

<project name="compile_library" default="help">

	<description>
		description: "Clib library compilation"
		author: "Jocelyn Fiat and others"
	</description>

	<inherit>
		<parent location="${EIFFEL_SRC}/scripts/misc/_common_.eant">
			<redefine target="help"/>
		</parent>
	</inherit>
	
	<target name="help">
		<echo message="usage:"/>
		<echo message=" geant  compile_library" />
	</target>	

	<!--
	**************************************************************************************
	***  C code preparation (compilation ...)                   **************************
	**************************************************************************************
	-->

	<target name="compile_all" depend="init">
		<geant target="compile_c_library" />
		<geant target="compile_library" />
		<geant target="compile_eiffel_framework" />

		<available resource="${ISE_LIBRARY}${path_separator}library${path_separator}gobo${path_separator}library" variable="gobo_available"/>
		<echo message="GOBO is already installed ${ISE_LIBRARY}${path_separator}library${path_separator}gobo${path_separator}library" if="${gobo_available}=true" />
		<geant target="extract_gobo" if="${gobo_available}=false" />
		<unset name="gobo_available" />
	</target>

		<!-- C_library -->
	<target name="compile_c_library" depend="init" if="${is_windows}" >
		<set name="old_ISE_EIFFEL" value="${ISE_EIFFEL}" />
		<setenv name="ISE_EIFFEL" value="${ISE_LIBRARY}" />

		<echo message="Compiler zlib" />
		<exec executable="make_${ISE_C_COMPILER}.bat" dir="${ISE_LIBRARY}/C_library/zlib" if="${is_windows}" 
			accept_errors="true" exit_code_variable="return_code" />

		<echo message="Compiler libpng" />
		<exec executable="make_${ISE_C_COMPILER}.bat" dir="${ISE_LIBRARY}/C_library/libpng" if="${is_windows}"
			accept_errors="true" exit_code_variable="return_code" />

		<setenv name="ISE_EIFFEL" value="${old_ISE_EIFFEL}" />
		<unset name="old_ISE_EIFFEL" />
	</target>

		<!-- library -->
	<target name="compile_library" depend="init">
		<echo message="Compile net clib" />
		<exec executable="make_${ISE_C_COMPILER}.bat" dir="${ISE_LIBRARY}/library/net/Clib" if="${is_windows}" 
			accept_errors="true" exit_code_variable="return_code" />
		<exec executable="finish_freezing -library" dir="${ISE_LIBRARY}/library/net/Clib" unless="${is_windows}" 
			accept_errors="true" exit_code_variable="return_code" />

		<echo message="Compile vision2 clib" />
		<exec executable="make_${ISE_C_COMPILER}.bat" dir="${ISE_LIBRARY}/library/vision2/Clib" if="${is_windows}"
			accept_errors="true" exit_code_variable="return_code" />
		<exec executable="finish_freezing -library" dir="${ISE_LIBRARY}/library/vision2/Clib" unless="${is_windows}" 
			accept_errors="true" exit_code_variable="return_code" />

		<echo message="Compile wel clib" />
		<exec executable="make_${ISE_C_COMPILER}.bat" dir="${ISE_LIBRARY}/library/wel/clib" if="${is_windows}"
			accept_errors="true" exit_code_variable="return_code" />

		<echo message="Compile vision2/gtk clib" />
		<exec executable="finish_freezing -library" dir="${ISE_LIBRARY}/library/vision2/implementation/gtk/Clib" unless="${is_windows}" 
			accept_errors="true" exit_code_variable="return_code" />
	</target>

	<target name="extract_gobo" depend="init">
		<echo message="Extracting Gobo"/>
		<copy file="${EIFFEL_SRC}\..\free_add_ons\gobo\gobo_34_win.tgz" to_file="${ISE_LIBRARY}${path_separator}library${path_separator}gobo.tgz" if="${is_windows}" />
		<copy file="${EIFFEL_SRC}/../free_add_ons/gobo/gobo_34_unix.tgz" to_file="${ISE_LIBRARY}${path_separator}library${path_separator}gobo.tgz" unless="${is_windows}" />

		<available resource="${ISE_LIBRARY}${path_separator}library${path_separator}gobo.tgz" variable="tmp_available"/>
		<exec executable="tar xzvf gobo.tgz" dir="${ISE_LIBRARY}${path_separator}library"
			accept_errors="true" exit_code_variable="return_code" if="$tmp_available" />
		<delete file="${ISE_LIBRARY}${path_separator}library${path_separator}gobo.tgz" if="$tmp_available" />
	</target>

	<target name="compile_eiffel_framework" depend="init" if="${is_windows}" >
		<echo message="Compile Eiffel framework externals lib" />
		<echo message="Compile dotnet IL runtime" />
		<exec executable="nmake /f Makefile" dir="${EIFFEL_SRC}\Eiffel\eiffel\com_il_generation\Core\run-time" if="${is_windows}" 
			accept_errors="true" exit_code_variable="return_code" />

		<echo message="Compile cli_writer" />
		<exec executable="nmake /f Makefile" dir="${EIFFEL_SRC}\framework\cli_writer\Clib" if="${is_windows}" 
			accept_errors="true" exit_code_variable="return_code" />

		<echo message="Compile cli_debugger" />
		<exec executable="nmake /f Makefile" dir="${EIFFEL_SRC}\framework\cli_debugger\Clib" if="${is_windows}" 
			accept_errors="true" exit_code_variable="return_code" />
	</target>
	
</project>
