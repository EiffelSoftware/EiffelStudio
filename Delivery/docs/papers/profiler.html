<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>Profiler</title>
<link rev="made" href="mailto:webmaster@eiffel.com">
<link rel="stylesheet" href="../styles/tech.css" type="text/css">
<meta name="Microsoft Border" content="t, default">
</head>

<body><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td><table border="0" cellspacing="0" cellpadding="0" width="100%">
  <tr>
    <td valign="top" bgcolor="#000063" width="291"><b><font face="Arial" size="4" color="#FFFFFF">Interactive<br>
      Software Engineering</font></b></td>
    <td valign="top" bgcolor="#000063" width="720"><b><font face="Arial" size="6" color="#FFFFCC">Analyzing performance of Eiffel systems</font></b></td>
  </tr>
  <tr>
    <td colspan="2" valign="top" width="100%">
<p align="center">[<a href="http://eiffel.com">ISE Home</a>] <nobr>[&nbsp;<a href="../index.html">Home</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../release_notes.html">Release&nbsp;Notes</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="index.html">Technology&nbsp;Papers</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../install.html">Installation&nbsp;Notes</a>&nbsp;]</nobr> <nobr>[&nbsp;<a href="../Eiffel/index.html">About&nbsp;Eiffel</a>&nbsp;]</nobr>
<hr>

    </td>
  </tr>
</table></td></tr><!--msnavigation--></table><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><!--msnavigation--><td valign="top"><table cols="1" cellpadding="5" cellspacing="0" border="0">
<tr><td>

<h1>1 INTRODUCTION</h1>
<p>
 ISE Eiffel offers EiffelProfile, a profiling mechanism enabling Eiffel users to&nbsp;analyze the run-time properties of their systems and in particular the cost of each&nbsp;routine: number of calls, time spent.
EiffelProfile is a precious tool to understand systems and optimize them.</p>
<p>
This document describes how to use EiffelProfile. It is divided into the following&nbsp;sections:</p>
    <ul>
      <li>Principles and general organization (section 2).</li>
      <li>Lace options to be included for profiling (section 3).</li>
      <li>How to instruct your software in preparation for EiffelProfile's work&nbsp;(section 4).</li>
      <li>How to obtain, analyze and process the results of EiffelProfile (section 5).<br>
      </li>
    </ul>
<h1>2 EIFFELPROFILE: GENERAL ORGANIZATION</h1>
<p>
EiffelProfile works on the basis of one or more Execution Profiles: files containing&nbsp;information about an execution of your system, and files generated by that execution.&nbsp;EiffelProfile lets you analyze the Execution Profiles to obtain information about&nbsp;the calling and timing patterns of your system.</p>
<p>
To ensure that an execution of your system will generate an Execution Profile, you&nbsp;must compile it using an appropriate Lace option: profile. You may choose to profile
the entire system, or only some specific clusters and classes.</p>
<p>
For the time analysis you can use either ISE Eiffel's own timing mechanism or an&nbsp;external profiler such as GNU's gprof or Pure Atria's Quantify.
An execution of the system will generate an internal file containing the appropriate
information. You then run a conversion tool to transform this file into an Execution
Profile.</p>
<p>
Once you have generated one or more Execution Profiles, EiffelProfile provides you&nbsp;with a powerful query language enabling you to produce the information that you need
for the purpose of your analysis.</p>
<p>
The following sections detail the steps in this process.</p>
<p>
The mechanisms of EiffelProfile exist under two interfaces:</p>
<ul>
  <li>graphical, under&nbsp;EiffelBench</li>
  <li>command-line, under es4 -loop.</li>
</ul>
<p>
This version of the manual details&nbsp;both the textual and the graphical interface; the various commands are available&nbsp;under the (P) Profile option of es4 -loop. (For a general presentation of es4 -loop&nbsp;see Eiffel: The Environment.) The EiffelBench version offers exactly the same&nbsp;facilities, in graphical form.</p>
<p>&nbsp;</p>
<h1>3 LACE OPTIONS FOR INSTRUMENTING A SYSTEM</h1>
<p>
To obtain an Execution Profile you must run your system after compiling it with the
appropriate Lace options. The resulting compiled version of the system is said to be
instrumented, meaning that it includes special instructions that will generate the&nbsp;profiling information during execution.</p>
<p>
EiffelProfile supports two modes of profiling:</p>
    <ul>
      <li>You can use ISE Eiffel's own timing tools; this is known as internal&nbsp;profiling.</li>
      <li>You can instead rely on an third-party profiling tool such as GNU's gprof.&nbsp;This is known as external profiling.<br>
      </li>
    </ul>
<h2>
3.1  The profile option</h2>
<p>You will specify profiling through the profile option in your Ace file. The option&nbsp;is in the form of:</p>
<blockquote>
  <p><b>
	profile</b> (profiler_tool)</p>
</blockquote>
<p>
where profiler_tool indicates the desired form of profiling:</p>
    <ul>
      <li>yes for internal profiling.</li>
      <li>no to turn off profiling.</li>
      <li>For external profiling, the name of the profiler, for example "gprof". This&nbsp;must be the name of the corresponding executable, accessible through your path.</li>
    </ul>
<h2>
3.2  Including the option</h2>
<p>
For internal profiling, you can specify the profile option, like many other Lace&nbsp;options such as, trace and debug at the system, cluster or class level.<br>
Here is an example Ace using the option:
<blockquote>
<pre>system
	syst1

root
	ROOT_CLASS (ROOT_CLUSTER): &quot;creation_procedure&quot;

default
	assertion (require);
	precompiled (&quot;$EIFFEL5/precomp/spec/$PLATFORM/base&quot;);
	profile (no)

cluster

	root_cluster: &quot;.&quot;
		default
			 profile (yes)
		option
			profile (no): SOME_CLASS
		end;

	...
end -- system syst1
</pre>
</blockquote>
<p>
This turns on profiling for all classes or the root_cluster except SOME_CLASS, and&nbsp;turns it off for all other clusters (this would be the default).
For external profiling, you will turn on the option, under the form profile&nbsp;(profiler_tool), at the global default. However, even if you specify it at the&nbsp;Cluster level, the Eiffel profiling will be disabled.
<h2>
3.3  Generated files</h2>
<p>
If the profile option has been set, execution of the system will generate profiling&nbsp;information in a file which resides in one of the subdirectories of the project&nbsp;directory:
<p>
·	EIFGEN|W_code in workbench mode (melting or freezing).<br>
·	EIFGEN|F_code in finalized mode.
<p>
(As usual in ISE Eiffel documentation, the vertical bar | stands for the path&nbsp;delimiter: / on Unix, \ on Windows, the equivalent convention on VMS.)
For internal profiling, the name of the file is profinfo. For external profiling,&nbsp;it is determined by the external profiler being used.
<h1>
4  PRODUCING AN EXECUTION PROFILE</h1>
<p>
Once an execution of an instrumented system has generated the proper file, you must
process it through a profile converter to produce the Execution Profile. The need
for the converter comes from the various formats that profilers use to record&nbsp;run-time information during an execution; a simple Profiler Configuration File&nbsp;enables you to describe the format used by any particular profiler.
<h2>
4.1   Setting up the Profiler Configuration File</h2>
<p>
The Profiler Configuration File is a file found in the directory $EIFFEL5|bench|profiler
where $EIFFEL5 is the location of the Eiffel installation. The name of the&nbsp;Profiler Configuration File in that directory is eiffel for internal profiling&nbsp;and, for external profiling, the name of the profiler tool as specified in the&nbsp;profiler option.
<p>
The Profiler Configuration File describes the structure of the file generated by&nbsp;the profiler. Here is a complete example showing the various options that may be&nbsp;specified:
<blockquote>
<pre>
number_of_columns: 7
	-- Number of columns in the file.

index_column: 1
	-- Column where the index is stored.

function_time_column: 3
	-- Column where the time spent in the function is stored.

descendent_time_column: 4
	-- Column where the time spent in the descendents of a function is stored.

number_of_calls_column: 5
	-- Column where the number of calls to a function is stored.

function_name_column: 6
	-- Column where the name of the function is stored.

percentage_column: 2
	-- Column where the percentage of time spent in the function is stored.

second_percentage_column: 0
	-- Column where the second percentage of time spent in the function is&nbsp;stored.

generates_leading_underscore: no
	-- Says whether the profiler generates leading underscores (yes) or not&nbsp;(no).
</pre>
</blockquote>
<p>
As in Eiffel and Lace, -- introduces a comment, which has no effect on the&nbsp;specification. If one of the xxx_column options has value 0, this means that the&nbsp;files generated by the given profiler contain no such column. The order of the&nbsp;options is not significant.
<p>
&nbsp;
<h2>
4.2  Running the converter under EiffelBench</h2>
<p>
To run the profile converter under EiffelBench, in the Profile tool, select in the&nbsp;Command sub-menu Generate. A new window will appear and you will have to select:
    <ul>
      <li>the name of the file to be converted (default: profinfo)</li>
      <li>the compilation mode: workbench or finalized (default: workbench)</li>
      <li>the name of the profiler tool (default: eiffel)</li>
    </ul>
<p>
When you have checked these three fields, click on the ok button to launch the&nbsp;conversion. This will generate an Execution Profile stored in a file with the&nbsp;extension .pfi.
<p>
&nbsp;
<h2>
4.3  Running the converter under es4</h2>
<p>
To run the profile converter under the command-line interface, use the (G) Generate
command in the (P) Profile submenu of es4 -loop. This will generate an Execution&nbsp;Profile, stored in a file with the extension .pfi.&nbsp;<br>
<br>
When running the Generate command with no arguments, you will be prompted for the&nbsp;following information:
<p>
·	Name of file to be converted (default: profinfo).<br>
·	Compilation mode: workbench or finalized (default: workbench).<br>
·	Name of profiler tool (default: eiffel).
<p>
You can also type in the arguments directly without waiting to be prompted, as in
command => g profinfo freeze eiffel
<p>
&nbsp;
<h1>
5  THE QUERY MECHANISM UNDER EIFFELBENCH</h1>
<h2>
5.1  The Profile tool window</h2>
<p>
The Profile tool window looks like the following:&nbsp;
<p align="center">
<img border="0" src="../images/profil1.gif" width="358" height="517">
<h2>
5.1.1 Setting switches</h2>
<p>
Two sets of switches can be seen. It is useful to select what kind of information&nbsp;is relevant to you.
<h3>
5.1.1.1 Column output switches</h3>
<p>
Each switch turns off or on the corresponding column output. You have to toggle&nbsp;off or on depending upon what you would like to see in the result of the computation.
Here is the explanations of each switch:
    <ul>
      <li>
Calls: number of calls to this feature during the execution</li>
      <li>
Featurename: name of the feature</li>
      <li>
Total: number of seconds accounted for by this function</li>
      <li>
Self: number of seconds spent in this function itself</li>
      <li>
Descendants: number of seconds spent in the descendants of this function on behalf&nbsp;of this function</li>
      <li>
Percentage: percentage of the total running time of the program used by this&nbsp;function</li>
    </ul>
<p>&nbsp;</p>
<h3>
5.1.1.2 Profiled languages switches</h3>
<p>
These switches enable you to specify the language to which querying should be&nbsp;applied. If you select only one language, the query result will not contain any&nbsp;information about routines written in the other language.
The default is Eiffel only.
<p>
&nbsp;
<h3>
5.1.2 Loading Execution Profiles</h3>
<p align="center">
<img border="0" src="../images/profil3.gif" width="208" height="327">
<p>
<br>
The name of the Execution profile you are going to run a query on is initially set&nbsp;to profinfo.pfi.
The input file compilation mode is initially set to workbench. Select the correct&nbsp;compilation mode and you need not worry about the location of the selected Execution&nbsp;Profile. However, if you want to specify a file that is neither in EIFGEN|W_code&nbsp;nor EIFGEN|F_code, you are able do this by clicking on the Browse button.
You may also use wildcards, such as ? and *, to select more than one Execution&nbsp;profile.
<p>
&nbsp;
<h2>
5.2  Running a query</h2>
<p>
When running a query, you are able to type a complete query. After pressing the Run&nbsp;button, a new window will be displayed to show the result of the query.&nbsp;The total query can be either a single one or a set of subqueries separated by&nbsp;one of the two operators 'or' or 'and'.<br>
<br>
Each subquery must have the following syntax attribute operator value where attribute is one of:
    <ul>
      <li>
	featurename</li>
      <li>
	calls</li>
      <li>
	total</li>
      <li>
	self</li>
      <li>
	descendants</li>
      <li>
	percentage</li>
    </ul>
<p>
operator is one of: &lt;, >, &lt;=, >=, =, /=. in
<p>
and value is one of:</p>
    <ul>
      <li>
	An integer (for calls)</li>
      <li>
	A string (for featurename). The string may contain wild card characters: ?,&nbsp;standing for arbitrary characters, and *, standing for arbitrary&nbsp;substrings.</li>
      <li>
	A real value (for other attributes)</li>
      <li>
	An interval, of the form a-b for two values a and b.</li>
      <li>
	max</li>
      <li>
	min</li>
      <li>
	avg</li>
    </ul>
<p>&nbsp;</p>
<h2>
5.3  Viewing the result in the Profile query window</h2>
<p>
The query result window looks like
<p align="center">
<img border="0" src="../images/profil4.gif" width="700" height="620">
<p>
Note: all features, classes and clusters are still clickable in this screen.
<h3>
5.3.1 Refining queries</h3>
<p>
The following mechanisms enable you to specify more precisely what type of&nbsp;information is relevant.
<h3>
5.3.1.1 Adding subqueries</h3>
<p>
To refine your search, you are able to run subqueries. First, type a query.&nbsp;This query must follow the query syntax. When you are ready, press one of the 'and'&nbsp;or 'or' buttons. This sets the boolean operator that will be added beetween the&nbsp;active query and the new subquery you are adding. The result is then computed and&nbsp;displayed when you press the Run button.
<h3>
5.3.1.2 Changing operators</h3>
<p>
You are able to change subquery operators. To do so, select one or more&nbsp;subqueries, either in the active query or in the inactive subqueries list. Then,&nbsp;press the AND button to set selected subqueries operators to 'and', or the OR&nbsp;button to set selected subqueries operators to 'or'.&nbsp;Once you have changed some operators, press the Run button to see the result of the&nbsp;new active query.
<h3>
5.3.1.3 Inactivating subqueries</h3>
<p>
An inactivate subquery will not be taken into account during the computation of the
result.&nbsp;To inactivate one or more subqueries, select them in the active query by clicking&nbsp;once, and then press the right arrow button.
Once you have inactivated subqueries, press the Run button to see the result of the
new active query.
<h3>
5.3.1.4 Reactivating subqueries</h3>
<p>
You are able to reactivate a subquery that you may have inactivated before. To do so&nbsp;select one or more subqueries in the inactive subqueries list, and then press the&nbsp;left arrow button.
Once you have reactivated subqueries, press the Run button to see the result of the<br>
new active query.
<h3>
5.3.2 Running the new active query</h3>
<p>
Once you have modified the active query, by adding subqueries, changing subquery&nbsp;operators, inactivating subqueries or reactivating other ones, you can see the&nbsp;result by clicking on the Run button. The result is computed and then displayed in&nbsp;the text area.
<p>
&nbsp;
<h2>
5.4  Saving the result</h2>
<p>
You are able to save the result of the current query at any time by&nbsp;clicking on the Save button.
<p>
&nbsp;
<h1>
6 QUERY MECHANISM IN COMMAND-LINE MODE</h1>
<p>
By now you have at least one Execution Profile. EiffelProfile allows you to run a&nbsp;number of useful queries on the information it contains. The queries are all&nbsp;commands of the (G) Generate submenu or es4 -loop.
<h2>
6.1  Basic profiler menu</h2>
<p>
The Profile menu (obtained by selecting (G) Generate) looks like this:<pre>
	(S) Switches
	(U) Query
	(I) Input
	(L) Language
	(R) Run
	(G) Generate
	(E) Defaults
</pre>

<p>
In the actual system, this submenu and subsequent ones contain supplementary help&nbsp;information which will be omitted.
The (G) Generate submenu has already been studied; we will now review the others.
Type (U) at any time to go to the parent menu of the current menu.

<h2>
6.2  Setting switches</h2>

<p>
The (S) Switches submenu enables you to set global options. It leads you to the&nbsp;following set of choices:<pre>
	(N) Calls
	(F) Feature name
	(T) Total
	(S) Self
	(D) Descendants
	(P) Percentage
</pre>
<p>
Each one of these commands switches on or off the corresponding column output.  The&nbsp;default is set on for the first two, off for the others. To enable or disable a column,
type the name with a toggle effect.

<h2>
6.3  Defining queries</h2>

<p>
The (U) Query submenu enables you to define a set of queries. The result will be a&nbsp;Total Query; by default it is the boolean and all the queries you have entered&nbsp;individually, but you may deactivate some of these and choose other boolean&nbsp;operators.

<p>
The (U) Query submenu takes you to the following set of choices:<pre>	(A) Add
	(I) Inactivate
	(R) Reactivate
	(C) Operator
	(S) Show
</pre>

<p>
To get useful information, you should add the appropriate queries through (A) Add. Each individual query has the following form:
attribute operator value, where attribute is one of:
    <ul>
      <li>
	featurename</li>
      <li>calls</li>
      <li>
	total</li>
      <li>
	self</li>
      <li>
	descendants</li>
      <li>
	percentage</li>
    </ul>

<p>
operator is one of: &lt;, >, &lt;=, >=, =, /=, in<br>
<br>
and value is one of:
    <ul>
      <li>
	An integer (for calls)</li>
      <li>
	A string (for featurename). The string may contain wild card characters:\x11?, standing for arbitrary characters, and *, standing for arbitrary
    substrings.</li>
      <li>
	A real value (for other attributes)</li>
      <li>
	An interval, of the form a-b for two values a and b.</li>
      <li>
	max</li>
      <li>
	min</li>
      <li>
	avg</li>
    </ul>

<p>
The (S) Show command will display the current queries, each with an associated&nbsp;number. The output includes the total query, explained next.

<p>
To inactivate a query, use (I) Inactivate. You will be prompted for a query index,
which you may retrieve from (S) Show. This is useful if you make a change about a&nbsp;query, or want to set it aside for future use.

<p>
To reactivate a query, use (R) Reactivate. Again you will have to provide a query&nbsp;index.

<p>
The Total Query resulting from a succession of (A) Add commands, possibly with&nbsp;some (I) Inactivate and (R) Reactivate commands, is a boolean query resulting by&nbsp;default from adding all the currently active queries. For example after the&nbsp;following set of commands (note that command a outputs help lines, which have&nbsp;been skipped here):<br>
    <pre>	Command =&gt; a
		--&gt; Subquery: featurename = put*
	Command =&gt; a
		--&gt; Subquery: calls = 3
				-- Here we change our mind and deactivate the second query
				-- to replace it by calls = 3:
	Command =&gt; s
		All subqueries:
			[1] featurename = put* is active
			[2] calls = 3 is active
			The total active query:
				featurename = put* and
				calls &gt; 5
	Command =&gt; i
		--&gt; Subquery index: 2
	Command =&gt; a
		--&gt; Subquery: calls &gt; 5
</pre>

<p>
The (S) Show command will show the following result:<pre>	Command =&gt; s
		All subqueries:
			[1] featurename = put* is active
			[2] calls = 3 is active
			[3] calls &gt; 5 is active
			The total active query:
				featurename = put* and
				calls &gt; 5
</pre>
<p>
To change the boolean operator to 'or' rather than 'and', use the (C) Operator&nbsp;command. It will prompt you for the index of the operator and the new value:<pre>	Command =&gt; c
		--&gt; Operator index followed by operator ('and' or 'or'): 1 or
	Command =&gt; s
		All subqueries:
			[1] featurename = put* is active
			[2] calls = 3 is active
			The total active query:
				featurename = put* or
				calls &gt; 5
</pre>

<h2>
6.4  Loading Execution Profiles</h2>

<p>
The (I) Input command serves to load Execution Profiles. It is initially set to
*.pfi meaning that it will load all files with extension pfi. By calling the command&nbsp;repeatedly with new arguments, you are able to load more Execution Profiles.
If you use the command without any argument, and the set of input files contained&nbsp;just one file, then the queries will use the last generated output. This avoids&nbsp;explicitly loading a file.

<h2>
6.5  Selecting profiled languages</h2>

<p>
The (L) Language command enables you to specify the languages to which profiling&nbsp;should be applied. You can specify Eiffel only, C only, or both. If you specify&nbsp;only one language, the query results will not contain any information about&nbsp;routines written in the other
language.

<p>
The default is Eiffel only. To switch to both Eiffel and C, use Command => l eiffel and c

<p>
To return to just Eiffel, simply type l.

<h2>
6.6  Running queries</h2>

<p>
To run the current total query, use (R) Run.

<p>
&nbsp;

<h1>
7 Profiling tuning</h1>
<p>Starting from version 4.5 of the ISE EiffelBench, ISE introduced a new class
which enables to stop and restart the Eiffel profiler. As a result, you can now
profile a portion of your code.

<pre>
feature -- Status setting

	start_profiling is
			-- Start profiling.

	stop_profiling is
			-- Stop profiling

end
</pre>

<P>A typical use is:

In your root creation procedure you need to stop the profiler right away, by doing the following code:

<pre>	create profiler_setting.make
	profiler_setting.stop_profiling
	.... -- Current code of your root creation procedure
	profiler_setting.start_profiling.
</pre>

<p>Then in the code you want to profile you need to reactivate it:

<pre>	create profiler_setting.make
	profiler_setting.start_profiling
	your_code_here		-- This code will be profiled only.
	profiler_setting.stop_profiling</pre>


<p>



<font color="#FF0000"><b>Note:</b></font> Do not forget to activate the profiler
ace option, otherwise the code presented above won't have any effects.



</td></tr></table>&nbsp;<!--msnavigation--></td></tr><!--msnavigation--></table></body>

</html>
