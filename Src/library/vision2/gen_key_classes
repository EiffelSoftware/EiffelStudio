#!/usr/bin/perl -w
#===============================================================================
# gen_key_classes
#-------------------------------------------------------------------------------
# interface/kernel/ev_key_constants.e
# implementation/mswin/support/ev_wel_key_conversion.e
# implementation/gtk/support/ev_gtk_key_conversion.e
#-------------------------------------------------------------------------------
# Date: $Date$
# Revision: $Revision$
#===============================================================================

# Initialize global soo-to-be-huge strings.

$v2_to_wel_array = "";
$wel_to_v2_array = "";
$v2_to_gtk_array = "";
$gtk_to_v2_array = "";
$key_strings = "";
$key_constants = "";
$gdk_externals = "";
$first = "";
$last = "";

# For every line in the file from stdin.
while (<>) {

	# Init array.
	@fields = ();
	
	# Ignore empty lines, those starting with whitespace and comments.
	if (!/^[\n 	#].*/) {
		chomp;

		# Separate comma separated fields.
		# Ignore commas preceded by %.
		s/%,/THIS_IS_A_COMMA/g;
		s/,/SEPARATOR/g;
		s/THIS_IS_A_COMMA/,/g;
		
		@fields = split (/SEPARATOR[ 	]*/,$_);
		
		# Create Eiffel comment.
		$comment = shift (@fields);
		$comment = "-- Code representing $comment.";

		# Create Eiffel identifier.
		$identifier = shift (@fields);
		$identifier = "Key_$identifier";
		$last = $identifier;
		if ($first eq "") { $first = $identifier; }

		# Create literal string.
		$string = shift (@fields);
		$string = "\"$string\"";

		# Create GTK-code with GDK external.
		$gdk_ext = shift (@fields);
		$gtk_code = "${identifier}_keysym";
		
		$wel_code = shift (@fields);

		if (@fields > 0) {
			$id_override = shift (@fields);
			$id_override = "Key_$id_override";
		} else {
			$id_override = "";
		}

		# Append to the big strings.
		if ($id_override eq "") {
			$eif_statement = "Result.put ($wel_code, $identifier)";
			$v2_to_wel_array = "$v2_to_wel_array\t\t\t$eif_statement\n";
			$eif_statement = "Result.put ($identifier, $wel_code)";
		} else {
			$eif_statement = "Result.put ($id_override, $wel_code)";
		}
		$wel_to_v2_array = "$wel_to_v2_array\t\t\t$eif_statement\n";

		if ($id_override eq "") {
			$eif_statement = "Result.put ($gtk_code, $identifier)";
			$v2_to_gtk_array = "$v2_to_gtk_array\t\t\t$eif_statement\n";
			$eif_statement = "Result.put ($identifier, $gtk_code)";
		} else {
			$eif_statement = "Result.put ($id_override, $gtk_code)";
		}
		$gtk_to_v2_array = "$gtk_to_v2_array\t\t\t$eif_statement\n";

		if ($id_override eq "") {
			$eif_statement = "Result.put ($string, $identifier)";
			$key_strings = "$key_strings\t\t\t$eif_statement\n";

			$eif_statement = "$identifier: INTEGER is unique";
			$key_constants = "$key_constants\n\t$eif_statement\n\t\t\t$comment\n";
		}

		$eif_statement = "\n\t$gtk_code: INTEGER is\n\t\texternal\n\t\t\t\"C [macro <gdk/gdkkeysyms.h>]\"\n\t\talias\n\t\t\t\"$gdk_ext\"\n\t\tend";
		$gdk_externals = "$gdk_externals$eif_statement\n";
	}
}

print "EV_KEY_CONSTANTS\n";

open (OH, ">" . "interface/kernel/ev_key_constants.e");
print OH <<EOT;
indexing
	description:
		"Eiffel Vision key constants. Each constant defined here %N%
		%corresponds to a possible value of {EV_KEY}.code"
	status: "See notice at end of class"
	keywords: "key, code, constant"
	date: "generated"
	revision: "generated"

class
	EV_KEY_CONSTANTS

feature -- Contract support

	valid_key_code (a_code: INTEGER): BOOLEAN is
			-- Is ``a_code'' a valid key code?
		do
			Result := a_code >= $first and then a_code <= $last
		end

feature -- Constants
$key_constants
feature -- Access

	key_strings: ARRAY [STRING] is
			-- String representations of all key codes.
		once
			create Result.make ($first, $last)
$key_strings		end

end -- class EV_KEY_CONSTANTS

--!-----------------------------------------------------------------------------
--! EiffelVision Library: library of reusable components for ISE Eiffel.
--! Copyright (C) 1986-2000 Interactive Software Engineering Inc.
--! All rights reserved. Duplication and distribution prohibited.
--! May be used only with ISE Eiffel, under terms of user license. 
--! Contact ISE for any other use.
--!
--! Interactive Software Engineering Inc.
--! ISE Building, 2nd floor
--! 270 Storke Road, Goleta, CA 93117 USA
--! Telephone 805-685-1006, Fax 805-685-6869
--! Electronic mail <info\@eiffel.com>
--! Customer support e-mail <support\@eiffel.com>
--! For latest info see award-winning pages: http://www.eiffel.com
--!-----------------------------------------------------------------------------
EOT
close (OH);

print "EV_WEL_KEY_CONVERSION\n";

open (OH, ">" . "implementation/mswin/support/ev_wel_key_conversion.e");
print OH <<EOT;
indexing
	description: "Eiffel Vision WEL key conversion. Provides a function%N%
		%for WEL to vision2 conversion and for vision2 to WEL conversion."
	status: "See notice at end of class"
	date: "generated"
	revision: "generated"

class
	EV_WEL_KEY_CONVERSION

inherit
	WEL_VK_CONSTANTS

	EV_KEY_CONSTANTS

feature -- Conversion

	key_code_to_wel (a_key_code: INTEGER): INTEGER is
			-- Corresponding WEL code for ``a_key_code''.
		require
			a_key_code_valid: valid_key_code (a_key_code)
		do
			Result := v2_to_wel_table @ a_key_code
		end

	key_code_from_wel (a_wel_code: INTEGER): INTEGER is
			-- Corresponding key code for ``a_wel_code''.
		require
			a_wel_code_valid: valid_wel_code (a_wel_code)
		do
			Result := wel_to_v2_table.item (a_wel_code)
		end

feature -- Contract support

	valid_wel_code (a_wel_code: INTEGER): BOOLEAN is
			-- Is ``a_wel_code'' valid?
		do
			Result := wel_to_v2_table.has (a_wel_code)
		end

feature {NONE} -- Implementation

	v2_to_wel_table: ARRAY [INTEGER] is
			-- WEL keycodes indexed by Vision2 key code.
		once
			create Result.make ($first, $last)
$v2_to_wel_array		end

	wel_to_v2_table: HASH_TABLE [INTEGER, INTEGER] is
			-- Vision2 keycodes indexed by WEL key code.
		once
			create Result.make (128)
$wel_to_v2_array		end

end -- class EV_WEL_KEY_CONVERSION

--!-----------------------------------------------------------------------------
--! EiffelVision2: library of reusable components for ISE Eiffel.
--! Copyright (C) 1986-2000 Interactive Software Engineering Inc.
--! All rights reserved. Duplication and distribution prohibited.
--! May be used only with ISE Eiffel, under terms of user license. 
--! Contact ISE for any other use.
--!
--! Interactive Software Engineering Inc.
--! ISE Building, 2nd floor
--! 270 Storke Road, Goleta, CA 93117 USA
--! Telephone 805-685-1006, Fax 805-685-6869
--! Electronic mail <info\@eiffel.com>
--! Customer support e-mail <support\@eiffel.com>
--! For latest info see award-winning pages: http://www.eiffel.com
--!-----------------------------------------------------------------------------
EOT
close (OH);

print "EV_GTK_KEY_CONVERSION\n";

open (OH, ">" . "implementation/gtk/support/ev_gtk_key_conversion.e");
print OH <<EOT;
indexing
	description: "Eiffel Vision GTK key conversion. Provides a function%N%
		%for GTK to vision2 conversion and for vision2 to GTK conversion."
	status: "See notice at end of class"
	date: "generated"
	revision: "generated"

class
	EV_GTK_KEY_CONVERSION

inherit
	EV_KEY_CONSTANTS

feature -- Conversion

	key_code_to_gtk (a_key_code: INTEGER): INTEGER is
			-- Corresponding WEL code for ``a_key_code''.
		require
			a_key_code_valid: valid_key_code (a_key_code)
		do
			Result := v2_to_gtk_table @ a_key_code
		end

	key_code_from_gtk (a_gtk_code: INTEGER): INTEGER is
			-- Corresponding key code for ``a_gtk_code''.
		require
			a_gtk_code_valid: valid_gtk_code (a_gtk_code)
		do
			Result := gtk_to_v2_table.item (a_gtk_code)
		end

feature -- Contract support

	valid_gtk_code (a_gtk_code: INTEGER): BOOLEAN is
			-- Is ``a_gtk_code'' valid?
		do
			Result := gtk_to_v2_table.has (a_gtk_code)
		end

feature {NONE} -- Implementation

	v2_to_gtk_table: ARRAY [INTEGER] is
			-- GTK keycodes indexed by Vision2 key code.
		once
			create Result.make ($first, $last)
$v2_to_gtk_array		end

	gtk_to_v2_table: HASH_TABLE [INTEGER, INTEGER] is
			-- Vision2 keycodes indexed by GTK key code.
		once
			create Result.make (128)
$gtk_to_v2_array		end

feature {NONE} -- Externals
$gdk_externals
end -- class EV_GTK_KEY_CONVERSION

--!-----------------------------------------------------------------------------
--! EiffelVision2: library of reusable components for ISE Eiffel.
--! Copyright (C) 1986-2000 Interactive Software Engineering Inc.
--! All rights reserved. Duplication and distribution prohibited.
--! May be used only with ISE Eiffel, under terms of user license. 
--! Contact ISE for any other use.
--!
--! Interactive Software Engineering Inc.
--! ISE Building, 2nd floor
--! 270 Storke Road, Goleta, CA 93117 USA
--! Telephone 805-685-1006, Fax 805-685-6869
--! Electronic mail <info\@eiffel.com>
--! Customer support e-mail <support\@eiffel.com>
--! For latest info see award-winning pages: http://www.eiffel.com
--!-----------------------------------------------------------------------------
EOT
close (OH);

#===============================================================================
# CVS log
#===============================================================================
#
# $Log$
# Revision 1.12  2001/06/07 23:07:57  rogers
# Merged DEVEL branch into Main trunc.
#
# Revision 1.11.2.2  2000/08/31 18:03:21  oconnor
# added CAPS keys
#
# Revision 1.11.2.1  2000/05/03 19:08:24  oconnor
# mergred from HEAD
#
# Revision 1.11  2000/04/12 19:25:27  brendel
# Semicolons! (PERL, remember...?)
#
# Revision 1.10  2000/04/12 19:03:11  brendel
# Added output of classnames.
#
# Revision 1.9  2000/04/04 20:36:37  oconnor
# renamed *_enum to *_keysym to avoid clash with GEL
#
# Revision 1.8  2000/03/21 01:56:43  brendel
# Fixed HASH_TABLE.
#
# Revision 1.7  2000/03/18 00:27:38  brendel
# Implemented valid_wel_code.
#
# Revision 1.6  2000/03/18 00:06:06  brendel
# Implemented valid_gtk_code.
#
# Revision 1.5  2000/03/17 18:07:03  brendel
# Fixed cosmetics in generated code.
#
# Revision 1.4  2000/03/17 17:41:01  brendel
# Fixed compiler errors in generated code.
# Defined GDK externals in EV_GTK_KEY_CONVERSION.
#
# Revision 1.3  2000/03/17 02:14:54  brendel
# Now generates the classes in the right directory.
#
# Revision 1.2  2000/03/17 02:06:38  brendel
# Now generates all 3 classes.
#
#
#===============================================================================
# End of CVS log
#===============================================================================
