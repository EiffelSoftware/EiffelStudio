#!/bin/sh

# our script requires sh aliased to bash.

if [ $# -ge 3 ]; then
	remote_host=$1
	user=$2
	platform=$3
	if [ $# -ge 4 ]; then
		port=$4
	else
		port=22
	fi
	scp -P $port PorterPackage_all.tar $user@$remote_host:
		# Launch platform specific scripts
	ssh -p $port -l $user $remote_host "mkdir -p local/TEST_DELIV"
	ssh -p $port -l $user $remote_host "cd local/TEST_DELIV ; \rm -rf PorterPackage"
	ssh -p $port -l $user $remote_host "cd local/TEST_DELIV ; tar xvf ~/PorterPackage_all.tar"
		#Note: we use `export' because we expect the remote shell to be bash.
	ssh -p $port -l $user $remote_host "cd local/TEST_DELIV/PorterPackage; export ISE_PLATFORM=$platform ; bash ./compile_exes"
	ssh -p $port -l $user $remote_host "cd local/TEST_DELIV/PorterPackage; export ISE_PLATFORM=$platform ; bash ./make_images"

	scp -P $port "$user@$remote_host:local/TEST_DELIV/PorterPackage/Eiffel57_enterprise*gz" .
	scp -P $port "$user@$remote_host:local/TEST_DELIV/PorterPackage/Eiffel57_gpl*gz" .

	echo Compilation for $platform is now done
else
	echo Usage: host username platform [port]
fi
