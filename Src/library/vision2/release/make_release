#!/bin/bash
if [ "$1" = "" ]
then
	echo "usage: $0 release_tag"
	exit 1
fi
rm -rf vision2
cvs -d :pserver:$USER@cvs:/home/cvs export -r $1 vision2
cp RELEASE_NOTES vision2/
cd vision2
find | xargs touch -t
make
echo -n "."
rm -rf documentation perlvision.pl test Makefile components extra
mkdir test
mkdir figure_test
cp release/test/README test/
cp release/test/test.e test/
cp release/test/Ace.ace test/
cp release/test/Ace.win.ace test/
cp release/test/test_pixmap test/
cp release/test/*.png test/
cp release/figure_test/figure_test.e figure_test/
cp release/figure_test/Ace.ace figure_test/
cp release/make_msc.bat .
rm -rf release
echo -n "."
rm -rf `find . -name '*_notes*'`
echo -n "."
rm -rf `find . -name '*to_do*'`
echo -n "."
rm -rf `find . -name '*.def*'`
echo -n "."
rm -rf `find . -name 'gen_*'`
echo -n "."
for file in `find . -name '*.e'`
do
	if grep "^--| FIXME Not for release" $file > /dev/null 2>&1
	then
		echo "rm $file"
		rm -f $file
	else
		grep -v "Id:" $file > $file.new
		mv -f $file.new $file
		#if [ `grep -v \"C $file | fmt -s -w 80 | wc -l` != `grep -v \"C $file | wc -l` ]
		#then
		#	 echo "> 80 cols! $file"
		#fi
		grep -v "^[ 	]*--|" < $file > $file.tmp
		sed -e 's/[ 	]--|.*//g' < $file.tmp > $file
		rm -f $file.tmp
	fi
done
cd ..
cvs -d :pserver:$USER@cvs:/home/cvs export -r $1 base
cvs -d :pserver:$USER@cvs:/home/cvs export -r $1 gel
cvs -d :pserver:$USER@cvs:/home/cvs export -r $1 wel
cvs -d :pserver:$USER@cvs:/home/cvs export -r $1 event
cvs -d :pserver:$USER@cvs:/home/cvs export -r $1 C_library
mv C_library/* .
grep -v -- "--|" event/action_sequence.e > vision2/interface/support/action_sequence.e
grep -v -- "--|" event/active_list.e > vision2/interface/support/active_list.e
grep -v -- "--|" event/interactive_list.e > vision2/interface/support/interactive_list.e
echo "See vision2/RELEASE_NOTES" > README
tar czf $1.tgz make_msc.bat README vision2 base gel wel libpng zlib
rm -rf base gel event vision2 wel C_library libpng zlib
echo "Done!"
exit 0
