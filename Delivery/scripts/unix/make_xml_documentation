#!/bin/sh

remtrace Checkout up to date version of XML documentation files
cd $DOCUMENT_DIR
exprt -r $ORIGO_SVN_REVISION $DEFAULT_ORIGO_SVN/Documentation/xmldoc xmldoc

remtrace Checkout and compile the Documentation tool
cd $EIFFEL_SRC
safe_md tools
cd $EIFFEL_SRC/tools
co -r $ORIGO_SVN_REVISION $DEFAULT_ORIGO_SVN/Src/tools/doc_builder doc_builder
cd $EIFFEL_SRC/tools/doc_builder
ec -local -batch -finalize -config doc_builder.ecf -c_compile >> $INSTALL_LOG 2>&1
if [ ! -f EIFGENs/doc_builder/F_code/doc_builder ]; then
	remtrace Couldnt generate doc_builder
	CANCEL
else
	mv EIFGENs/doc_builder/F_code/doc_builder .
fi
rm -rf EIFGENs

remtrace Compile all required libraries and generate XML documentation
cd $EIFFEL_SRC/tools/doc_builder/resources/xml
ec -local -flatshort -filter xml -all -config all_libs.ecf >> $INSTALL_LOG 2>&1

remtrace Copy XML docs into appropriate written docs location
cd $EIFFEL_SRC/tools/doc_builder/resources/xml/Documentation
rm -rf *.html
rm -rf *_links.xml
rm -rf *_short.xml
cd vision2/implementation
rm -rf mswin
sed -e "s/^.*mswin.*$//g" index.xml >> new_index.xml
cp new_index.xml index.xml
rm -rf new_index.xml

cd ../contrib
rm -rf implementation
sed -e "s/^.*implementation.*$//g" index.xml >> new_index.xml
cp new_index.xml index.xml
rm -rf new_index.xml

cd ../../preferences
rm -rf registry_implementation
sed -e "s/^.*registry_implementation.*$//g" index.xml >> new_index.xml
cp new_index.xml index.xml
rm -rf new_index.xml

cd $EIFFEL_SRC/tools/doc_builder/resources/xml/Documentation

mv base $DOCUMENT_DIR/xmldoc/libraries/base/reference
mv wel $DOCUMENT_DIR/xmldoc/libraries/wel/reference
mv vision2 $DOCUMENT_DIR/xmldoc/libraries/vision2/reference
mv com $DOCUMENT_DIR/xmldoc/libraries/com/reference
mv eiffel2java $DOCUMENT_DIR/xmldoc/libraries/eiffel2java/reference
mv lex $DOCUMENT_DIR/xmldoc/libraries/lex/reference
mv parse $DOCUMENT_DIR/xmldoc/libraries/parse/reference
mv net $DOCUMENT_DIR/xmldoc/libraries/net/reference
mv thread $DOCUMENT_DIR/xmldoc/libraries/thread/reference
mv time $DOCUMENT_DIR/xmldoc/libraries/time/reference
mv web $DOCUMENT_DIR/xmldoc/libraries/web/reference
mv store $DOCUMENT_DIR/xmldoc/libraries/store/reference
mv preferences $DOCUMENT_DIR/xmldoc/libraries/preferences/reference

remtrace Deleting EIFGENs
rm -rf $EIFFEL_SRC/tools/doc_builder/resources/xml/EIFGENs

remtrace Run the documentation tool to generate the documentation for EiffelStudio as web based help
cd $EIFFEL_SRC/tools/doc_builder

export DOCUMENT_DIR
export EIFFEL_SRC

./doc_builder -gen /xml2help -o /studio -t /web_simple -nohtml $DOCUMENT_DIR/xmldoc/projects/documentation.dpr

mv output_log.txt $DOCUMENT_DIR/output_log.txt

move /tmp/doc_builder/Help $INSTALL_DIR/docs
rm -rf $INSTALL_DIR/docs/docs_settings.xml

fullrd $EIFFEL_SRC/xmldoc

cd $EIFFEL_SRC
