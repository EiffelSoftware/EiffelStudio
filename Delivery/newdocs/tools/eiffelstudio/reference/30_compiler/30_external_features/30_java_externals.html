<!DOCTYPE HTML public "-//W3C//DTD HTML 4.0 Frameset//EN">
<HTML>
	<HEAD>
		<TITLE>Java externals</TITLE>
		<META NAME="MS-HKWD" CONTENT="Java externals">
		<META NAME="MS-HKWD" CONTENT="externals, Java">
		<LINK REL=Stylesheet HREF="/default.css" TYPE="text/css">
	</HEAD>

	<BODY>
		<H1>Java externals</H1>
                        <h2>Introduction</h2>
                        <p>The Java interface allows you to call Java routines
                        or attributes from your Eiffel code. It uses the Java
                        Native Interface (JNI) provided by the Java Development
                        Kit (JDK) 1.1.4. You can get more information about the
                        JNI at:</p>
                        <blockquote>
                          <p><a href="http://java.sun.com/products/jdk/1.1/docs/guide/jni/index.html">http://java.sun.com/products/jdk/1.1/docs/guide/jni/index.html</a></p>
                        </blockquote>
                        <h3>Requirements</h3>
                        <ul>
                          <li>JDK 1.1.4 correctly set (download it at <a href="http://java.sun.com/products/jdk/1.1/index.html">http://java.sun.com/products/jdk/1.1/index.html</a>).
                          <li>The Java classes you want to use must be in the
                            environment variable CLASSPATH.</li>
                        </ul>
                        <h3>Limitations</h3>
                        <ul>
                          <li>In this version, you can only use one JNI
                            environment.
                          <li>Only one thread can interact with the Java Virtual
                            Machine (JVM).
                          <li>It is not possible to call Eiffel features from
                            Java programs.
                          <li>The Eiffel side cannot deal with 'long' integer
                            (64 bits).
                          <li>The Eiffel feature `destroy_vm' of `JAVA_VM'
                            calls a C function of the Java Native&nbsp;Interface
                            that is not fully implemented in jdk 1.1.4. This
                            function, called&nbsp;DestroyJavaVM, always returns
                            -1 in jdk 1.1.4. For further information, go on the&nbsp;JNI
                            pages at the address above.&nbsp;</li>
                        </ul>
                        <h2>Interface classes</h2>
                        <h3>JNI_ENVIRONMENT</h3>
                        <blockquote>
                          <p>Holds information about JNI environment.
                          Potentially many JNI environments can coexist,
                          but this was never tested. This class provides
                          the facilities to interact with the JVM:</p>
                          <ul>
                            <li>creation of instances of Java Classes
                            <li>exception mechanism
                            <li>destruction of the JVM</li>
                          </ul>
                        </blockquote>
                        <h3>SHARED_JNI_ENVIRONMENT</h3>
                        <blockquote>
                          <p>Shared JNI environment. Since one JNI is needed per
                          thread we limit&nbsp; Eiffel to having one thread that
                          deals with Java. The class that calls Java routines or
                          attributes must inherit from this class.&nbsp;</p>
                        </blockquote>
                        <h3>JAVA_VM</h3>
                        <blockquote>
                          <p>This class is used to initially load the JVM into
                          the running program. This is the Eiffel representation
                          of the JVM.</p>
                        </blockquote>
                        <h3>JAVA_CLASS</h3>
                        <blockquote>
                          <p>Access to Java classes. Static methods and
                          attributes are accessed&nbsp;via this class. This is
                          the Eiffel representation of a Java class.</p>
                        </blockquote>
                        <h3>JAVA_OBJECT</h3>
                        <blockquote>
                          <p>This class gives Eiffel access to Java objects. You
                          can use it&nbsp;directly or inherit it to create
                          a more convenient Eiffel&nbsp;class that makes the
                          Java object look like an Eiffel object.</p>
                          <p class="note"><b>Note</b>: to access the static fields or routines of
                          a Java class, you have to use the features of a
                          JAVA_CLASS instance.</p>
                        </blockquote>
                        <h3>JAVA_EXTERNALS</h3>
                        <blockquote>
                          <p>JNI external declarations. Don't use this class
                          directly.</p>
                        </blockquote>
                        <h3>JAVA_***_ARRAY</h3>
                        <blockquote>
                          <p>Access to Java array of &quot;***&quot;.
                          &quot;***&quot; can be all the usual types of Java
                          (byte, short, int, float, double, char, boolean) or
                          object if it is an array of Java objects (a String is
                          considered to be an object).</p>
                        </blockquote>
                        <h3>JAVA_ARGS</h3>
                        <blockquote>
                          <p>Class representing the arguments that can be passed
                          to a Java method. See below for the signature of the
                          methods.</p>
                        </blockquote>
                        <h3>JAVA_OBJECT_TABLE</h3>
                        <blockquote>
                          <p>This class provides a mapping between Java and
                          Eiffel objects.
                          <p><b>Mapping the Eiffel classes and the Java types:</b>
                          <blockquote>
                            <p>The following table describes the mapping of Java
                            primitive types and classes&nbsp;to Eiffel classes.&nbsp;<center>
                            <table border="1" width="300">
                              <tbody>
                                <tr>
                                  <td bgColor="#ffffcc" width="50%"><b>Java
                                    type/class</b></td>
                                  <td bgColor="#ffffcc" width="50%"><b>Eiffel
                                    class</b></td>
                                </tr>
                                <tr>
                                  <td width="50%">boolean</td>
                                  <td width="50%">BOOLEAN</td>
                                </tr>
                                <tr>
                                  <td width="50%">char, byte</td>
                                  <td width="50%">CHARACTER</td>
                                </tr>
                                <tr>
                                  <td width="50%">short, int, long</td>
                                  <td width="50%">INTEGER</td>
                                </tr>
                                <tr>
                                  <td width="50%">float</td>
                                  <td width="50%">REAL</td>
                                </tr>
                                <tr>
                                  <td width="50%">double</td>
                                  <td width="50%">DOUBLE</td>
                                </tr>
                                <tr>
                                  <td width="50%">String</td>
                                  <td width="50%">STRING</td>
                                </tr>
                                <tr>
                                  <td width="50%">void</td>
                                  <td width="50%">Void</td>
                                </tr>
                              </tbody>
                            </table>
                            </center>
                            <p>The interface does the mapping automatically. For
                            example, if you call a Java&nbsp;method that returns
                            a 'float', by using float_method you will get a
                            'REAL'.</p>
                          </blockquote>
                          <p><b>The signature of Java methods and attributes:</b></p>
                          <blockquote>
                            <p>When you want to call a Java method or access a
                            field, you need to specify its signature.&nbsp;The
                            Eiffel to Java interface follows the JNI
                            specifications.&nbsp;The table below summarizes the
                            encoding for the Java type signatures:&nbsp;</p>
                            <center>
                            <table border="1" width="300">
                              <tbody>
                                <tr>
                                  <td bgColor="#ffffcc" width="50%"><b>Signature</b></td>
                                  <td bgColor="#ffffcc" width="50%"><b>Java Type</b></td>
                                </tr>
                                <tr>
                                  <td width="50%">Z</td>
                                  <td width="50%">boolean</td>
                                </tr>
                                <tr>
                                  <td width="50%">B</td>
                                  <td width="50%">byte</td>
                                </tr>
                                <tr>
                                  <td width="50%">C</td>
                                  <td width="50%">char</td>
                                </tr>
                                <tr>
                                  <td width="50%">S</td>
                                  <td width="50%">short</td>
                                </tr>
                                <tr>
                                  <td width="50%">I</td>
                                  <td width="50%">int</td>
                                </tr>
                                <tr>
                                  <td width="50%">J</td>
                                  <td width="50%">long</td>
                                </tr>
                                <tr>
                                  <td width="50%">F</td>
                                  <td width="50%">float</td>
                                </tr>
                                <tr>
                                  <td width="50%">D</td>
                                  <td width="50%">double</td>
                                </tr>
                                <tr>
                                  <td width="50%">V</td>
                                  <td width="50%">void</td>
                                </tr>
                                <tr>
                                  <td width="50%">[type</td>
                                  <td width="50%">type []</td>
                                </tr>
                              </tbody>
                            </table>
                            </center>
                            <p>The signature for a Java class has the following
                            form:</p>
                            <blockquote>
                              <p>Lfully-qualified-class ;</p>
                              <p>For example, class String: Ljava/lang/String;</p>
                            </blockquote>
                            <p>The signature for a method has the following
                            form:</p>
                            <blockquote>
                              <p>( arguments-types ) returned-types</p>
                              <p>For example, the signature of a method that
                              takes&nbsp;as arguments an integer and a string
                              and return void is:</p>
                              <p>(ILjava/lang/String;)V</p>
                            </blockquote>
                          </blockquote>
                        </blockquote>
                        <h2>An example</h2>
                        <pre>			## the Java Class ##
class test {
	test () {}
	public int my_integer;
	public static in my_static_integer;
	public void my_method (int arg_int, String arg_string) {
		...
	}
	...
}

			## the Eiffel Side ##
<span class="ekeyword">class</span>
	<span class="eclass">EIFFEL_TO_JAVA</span>
		
<span class="ekeyword">inherit</span>
	<span class="eclass">SHARED_JNI_ENVIRONMENT</span>

<span class="ekeyword">creation</span>
	<span class="efeature">make</span>

<span class="ekeyword">feature</span> <span class="ecomment">-- Creation</span>

	<span class="efeature">make</span> <span class="ekeyword">is</span>
		<span class="ekeyword">local</span>
			class_test: <span class="eclass">JAVA_CLASS</span>
			instance_of_class_test: <span class="eclass">JAVA_OBJECT</span>
			fid: <span class="eclass">POINTER</span>
			value: <span class="eclass">INTEGER</span>
			j_args: <span class="eclass">JAVA_ARGS</span>
		<span class="ekeyword">do</span>
			<span class="ecomment">--| Creation of the Java object</span>

			class_test := <span class="efeature">jni</span>.<span class="efeature">find_class</span> (&quot;test&quot;)
			<span class="ekeyword">create</span> instance_of_class_test.<span class="efeature">create_instance</span> (class_test, &quot;()V&quot;, <span class="ekeyword">Void</span>)
				
			<span class="ecomment">--| Access to a public attribute</span>

			fid := instance_of_class_test.<span class="efeature">field_id</span> (&quot;my_integer&quot;, &quot;I&quot;)
				<span class="ecomment">-- 'fid' contains the id of the field 'my_integer'</span>

			value := instance_of_class_test.<span class="efeature">integer_attribute</span> (fid)
				<span class="ecomment">-- 'value' contains the value of the field referenced</span>
				<span class="ecomment">-- by 'fid'</span>
			...

			<span class="ecomment">--| Access to a static attribute using directly the JAVA_CLASS</span>

			fid := class_test.<span class="efeature">field_id</span> (&quot;my_static_integer&quot;, &quot;I&quot;)
			value := class_test.<span class="efeature">integer_attribute</span> (fid)
			...

			<span class="ecomment">--| Access to a static attribute using the attribute 'jclass'</span>

			fid := instance_of_class_test.<span class="efeature">jclass</span>.<span class="efeature">field_id</span> (&quot;my_static_integer&quot;, &quot;I&quot;)
			value := instance_of_class_test.<span class="efeature">jclass</span>.<span class="efeature">integer_attribute</span> (fid)
			...

			<span class="ecomment">--| Access to the method 'my_method'</span>
			fid := instance_of_class_test.<span class="efeature">method_id</span> (&quot;my_method&quot;, &quot;(ILjava/lang/String;)V&quot;)
				<span class="ecomment">-- Get the id of 'my_method'</span>

			<span class="ekeyword">create</span> j_args.<span class="efeature">make</span>(2)
			j_args.<span class="efeature">push_int</span> (2)
			j_args.<span class="efeature">push_string</span>(&quot;String test&quot;)
				<span class="ecomment">-- Create the set of arguments for 'my_method'</span>

			instance_of_class_test.<span class="efeature">void_method</span> (fid, j_args)
				<span class="ecomment">-- Call to the void method referenced by 'fid'</span>
			...
			
		<span class="ekeyword">end</span> <span class="ecomment">-- make</span>

<span class="ekeyword">end</span> <span class="ecomment">-- class EIFFEL_TO_JAVA</span></pre>
	</BODY>
</HTML>
